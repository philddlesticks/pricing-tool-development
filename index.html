<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing List Processing Tool</title>
    <link rel="stylesheet" href="pricingstyles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üìä Pricing List Processing Tool</h1>
        <p class="subtitle">Upload, edit, and compare pricing data with change detection</p>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="goToStep(1)">üõ†Ô∏è Settings</button>
            <button class="tab-btn" onclick="goToStep(2)">üó∫Ô∏è Map Columns</button>
            <button class="tab-btn" onclick="goToStep(3)">‚úèÔ∏è Edit Data</button>
            <button class="tab-btn" onclick="goToStep(4)">üîç Review</button>
            <button class="tab-btn" onclick="goToStep(5)">üìú Previous List</button>
            <button class="tab-btn" onclick="goToStep(6)">üìã Original List</button>
            <button class="tab-btn" onclick="goToStep(7)">üí± Forex Calc</button>
            <button class="tab-btn" onclick="goToStep(8)">üì§ OW Import</button>
        </div>

        <!-- Step 1: Settings -->
        <div id="step1" class="step active">
            <div class="step-header">Step 1: Settings</div>

            <div class="alert alert-info">
                Enter the pricing list details below before uploading your file.
            </div>

            <div style="max-width: 600px; margin: 0 auto;">
                <div class="mapping-item" style="margin-bottom: 20px;">
                    <label>Region:</label>
                    <select id="region" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="GB">GB</option>
                        <option value="BE">BE</option>
                    </select>
                </div>

                <div class="mapping-item" style="margin-bottom: 20px;">
                    <label>Manufacturer Name (or "Multiple Manufacturers"):</label>
                    <input type="text" id="manufacturerName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="Enter manufacturer or brand name">
                </div>

                <div class="mapping-item" style="margin-bottom: 20px;">
                    <label>Default COO (Country of Origin):</label>
                    <select id="defaultCOO" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="??">?? - Unknown</option>
                        <option value="AF">AF - Afghanistan</option>
                        <option value="AX">AX - √Öland Islands</option>
                        <option value="AL">AL - Albania</option>
                        <option value="DZ">DZ - Algeria</option>
                        <option value="AS">AS - American Samoa</option>
                        <option value="AD">AD - Andorra</option>
                        <option value="AO">AO - Angola</option>
                        <option value="AI">AI - Anguilla</option>
                        <option value="AQ">AQ - Antarctica</option>
                        <option value="AG">AG - Antigua and Barbuda</option>
                        <option value="AR">AR - Argentina</option>
                        <option value="AM">AM - Armenia</option>
                        <option value="AW">AW - Aruba</option>
                        <option value="AU">AU - Australia</option>
                        <option value="AT">AT - Austria</option>
                        <option value="AZ">AZ - Azerbaijan</option>
                        <option value="BS">BS - Bahamas</option>
                        <option value="BH">BH - Bahrain</option>
                        <option value="BD">BD - Bangladesh</option>
                        <option value="BB">BB - Barbados</option>
                        <option value="BY">BY - Belarus</option>
                        <option value="BE">BE - Belgium</option>
                        <option value="BZ">BZ - Belize</option>
                        <option value="BJ">BJ - Benin</option>
                        <option value="BM">BM - Bermuda</option>
                        <option value="BT">BT - Bhutan</option>
                        <option value="BO">BO - Bolivia</option>
                        <option value="BA">BA - Bosnia And Herzegovina</option>
                        <option value="BW">BW - Botswana</option>
                        <option value="BV">BV - Bouvet Island</option>
                        <option value="BR">BR - Brazil</option>
                        <option value="IO">IO - British Indian Ocean Territory</option>
                        <option value="BN">BN - Brunei Darussalam</option>
                        <option value="BG">BG - Bulgaria</option>
                        <option value="BF">BF - Burkina Faso</option>
                        <option value="BI">BI - Burundi</option>
                        <option value="KH">KH - Cambodia</option>
                        <option value="CM">CM - Cameroon</option>
                        <option value="CA">CA - Canada</option>
                        <option value="IC">IC - Canary Islands</option>
                        <option value="CV">CV - Cape Verde</option>
                        <option value="KY">KY - Cayman Islands</option>
                        <option value="CF">CF - Central African Republic</option>
                        <option value="TD">TD - Chad</option>
                        <option value="CL">CL - Chile</option>
                        <option value="CN">CN - China</option>
                        <option value="CX">CX - Christmas Island</option>
                        <option value="CC">CC - Cocos (Keeling) Islands</option>
                        <option value="CO">CO - Colombia</option>
                        <option value="KM">KM - Comoros</option>
                        <option value="CG">CG - Congo</option>
                        <option value="CD">CD - The Democratic Republic Of The Congo</option>
                        <option value="CK">CK - Cook Islands</option>
                        <option value="CR">CR - Costa Rica</option>
                        <option value="CI">CI - C√¥te D'ivoire</option>
                        <option value="HR">HR - Croatia</option>
                        <option value="CU">CU - Cuba</option>
                        <option value="CW">CW - Curacao</option>
                        <option value="CY">CY - Cyprus</option>
                        <option value="CZ">CZ - Czech Republic</option>
                        <option value="DK">DK - Denmark</option>
                        <option value="DJ">DJ - Djibouti</option>
                        <option value="DM">DM - Dominica</option>
                        <option value="DO">DO - Dominican Republic</option>
                        <option value="EC">EC - Ecuador</option>
                        <option value="EG">EG - Egypt</option>
                        <option value="SV">SV - El Salvador</option>
                        <option value="GQ">GQ - Equatorial Guinea</option>
                        <option value="ER">ER - Eritrea</option>
                        <option value="EE">EE - Estonia</option>
                        <option value="ET">ET - Ethiopia</option>
                        <option value="FK">FK - Falkland Islands (Malvinas)</option>
                        <option value="FO">FO - Faroe Islands</option>
                        <option value="FJ">FJ - Fiji</option>
                        <option value="FI">FI - Finland</option>
                        <option value="FR">FR - France</option>
                        <option value="GF">GF - French Guiana</option>
                        <option value="PF">PF - French Polynesia</option>
                        <option value="TF">TF - French Southern Territories</option>
                        <option value="GA">GA - Gabon</option>
                        <option value="GM">GM - Gambia</option>
                        <option value="GE">GE - Georgia</option>
                        <option value="DE">DE - Germany</option>
                        <option value="GH">GH - Ghana</option>
                        <option value="GI">GI - Gibraltar</option>
                        <option value="EL">EL - Greece</option>
                        <option value="GL">GL - Greenland</option>
                        <option value="GD">GD - Grenada</option>
                        <option value="GP">GP - Guadeloupe</option>
                        <option value="GU">GU - Guam</option>
                        <option value="GT">GT - Guatemala</option>
                        <option value="GG">GG - Guernsey</option>
                        <option value="GN">GN - Guinea</option>
                        <option value="GW">GW - Guinea-Bissau</option>
                        <option value="GY">GY - Guyana</option>
                        <option value="HT">HT - Haiti</option>
                        <option value="HM">HM - Heard Island And Mcdonald Islands</option>
                        <option value="VA">VA - Holy See (Vatican City State)</option>
                        <option value="HN">HN - Honduras</option>
                        <option value="HK">HK - Hong Kong</option>
                        <option value="HU">HU - Hungary</option>
                        <option value="IS">IS - Iceland</option>
                        <option value="IN">IN - India</option>
                        <option value="ID">ID - Indonesia</option>
                        <option value="IR">IR - Iran (Islamic Republic Of)</option>
                        <option value="IQ">IQ - Iraq</option>
                        <option value="IE">IE - Ireland</option>
                        <option value="IM">IM - Isle Of Man</option>
                        <option value="IL">IL - Israel</option>
                        <option value="IT">IT - Italy</option>
                        <option value="JM">JM - Jamaica</option>
                        <option value="JP">JP - Japan</option>
                        <option value="JE">JE - Jersey</option>
                        <option value="JO">JO - Jordan</option>
                        <option value="KZ">KZ - Kazakhstan</option>
                        <option value="KE">KE - Kenya</option>
                        <option value="KI">KI - Kiribati</option>
                        <option value="KP">KP - Korea (North)</option>
                        <option value="KR">KR - Korea (South)</option>
                        <option value="XK">XK - Kosovo</option>
                        <option value="KW">KW - Kuwait</option>
                        <option value="KG">KG - Kyrgyzstan</option>
                        <option value="LA">LA - Lao People's Democratic Republic</option>
                        <option value="LV">LV - Latvia</option>
                        <option value="LB">LB - Lebanon</option>
                        <option value="LS">LS - Lesotho</option>
                        <option value="LR">LR - Liberia</option>
                        <option value="LY">LY - Libyan Arab Jamahiriya</option>
                        <option value="LI">LI - Liechtenstein</option>
                        <option value="LT">LT - Lithuania</option>
                        <option value="LU">LU - Luxembourg</option>
                        <option value="MO">MO - Macao</option>
                        <option value="MK">MK - Macedonia (The Former Yugoslav Republic Of)</option>
                        <option value="MG">MG - Madagascar</option>
                        <option value="MW">MW - Malawi</option>
                        <option value="MY">MY - Malaysia</option>
                        <option value="MV">MV - Maldives</option>
                        <option value="ML">ML - Mali</option>
                        <option value="MT">MT - Malta</option>
                        <option value="MH">MH - Marshall Islands</option>
                        <option value="MQ">MQ - Martinique</option>
                        <option value="MR">MR - Mauritania</option>
                        <option value="MU">MU - Mauritius</option>
                        <option value="YT">YT - Mayotte</option>
                        <option value="MX">MX - Mexico</option>
                        <option value="FM">FM - Micronesia (Federated States Of)</option>
                        <option value="MD">MD - Moldova (Republic Of)</option>
                        <option value="MC">MC - Monaco</option>
                        <option value="MN">MN - Mongolia</option>
                        <option value="ME">ME - Montenegro</option>
                        <option value="MS">MS - Montserrat</option>
                        <option value="MA">MA - Morocco</option>
                        <option value="MZ">MZ - Mozambique</option>
                        <option value="MM">MM - Myanmar</option>
                        <option value="NA">NA - Namibia</option>
                        <option value="NR">NR - Nauru</option>
                        <option value="NP">NP - Nepal</option>
                        <option value="NL">NL - Netherlands</option>
                        <option value="AN">AN - Netherlands Antilles</option>
                        <option value="NC">NC - New Caledonia</option>
                        <option value="NZ">NZ - New Zealand</option>
                        <option value="NI">NI - Nicaragua</option>
                        <option value="NE">NE - Niger</option>
                        <option value="NG">NG - Nigeria</option>
                        <option value="NU">NU - Niue</option>
                        <option value="NF">NF - Norfolk Island</option>
                        <option value="MP">MP - Northern Mariana Islands</option>
                        <option value="NO">NO - Norway</option>
                        <option value="OM">OM - Oman</option>
                        <option value="PK">PK - Pakistan</option>
                        <option value="PW">PW - Palau</option>
                        <option value="PS">PS - Palestinian Territory Occupied</option>
                        <option value="PA">PA - Panama</option>
                        <option value="PG">PG - Papua New Guinea</option>
                        <option value="PY">PY - Paraguay</option>
                        <option value="PE">PE - Peru</option>
                        <option value="PH">PH - Philippines</option>
                        <option value="PN">PN - Pitcairn</option>
                        <option value="PL">PL - Poland</option>
                        <option value="PT">PT - Portugal</option>
                        <option value="PR">PR - Puerto Rico</option>
                        <option value="QA">QA - Qatar</option>
                        <option value="RE">RE - R√©union</option>
                        <option value="RO">RO - Romania</option>
                        <option value="RU">RU - Russian Federation</option>
                        <option value="RW">RW - Rwanda</option>
                        <option value="BL">BL - Saint Barth√©lemy</option>
                        <option value="SH">SH - Saint Helena</option>
                        <option value="KN">KN - Saint Kitts And Nevis</option>
                        <option value="LC">LC - Saint Lucia</option>
                        <option value="MF">MF - Saint Martin</option>
                        <option value="PM">PM - Saint Pierre And Miquelon</option>
                        <option value="VC">VC - Saint Vincent And The Grenadines</option>
                        <option value="WS">WS - Samoa</option>
                        <option value="SM">SM - San Marino</option>
                        <option value="ST">ST - Sao Tome And Principe</option>
                        <option value="SA">SA - Saudi Arabia</option>
                        <option value="SN">SN - Senegal</option>
                        <option value="RS">RS - Serbia</option>
                        <option value="SC">SC - Seychelles</option>
                        <option value="SL">SL - Sierra Leone</option>
                        <option value="SG">SG - Singapore</option>
                        <option value="SK">SK - Slovakia</option>
                        <option value="SI">SI - Slovenia</option>
                        <option value="SB">SB - Solomon Islands</option>
                        <option value="SO">SO - Somalia</option>
                        <option value="ZA">ZA - South Africa</option>
                        <option value="GS">GS - South Georgia And The South Sandwich Islands</option>
                        <option value="ES">ES - Spain</option>
                        <option value="LK">LK - Sri Lanka</option>
                        <option value="SD">SD - Sudan</option>
                        <option value="SR">SR - Suriname</option>
                        <option value="SJ">SJ - Svalbard And Jan Mayen</option>
                        <option value="SZ">SZ - Swaziland</option>
                        <option value="SE">SE - Sweden</option>
                        <option value="CH">CH - Switzerland</option>
                        <option value="SY">SY - Syrian Arab Republic</option>
                        <option value="TW">TW - Taiwan</option>
                        <option value="TJ">TJ - Tajikistan</option>
                        <option value="TZ">TZ - Tanzania United Republic Of</option>
                        <option value="TH">TH - Thailand</option>
                        <option value="TL">TL - Timor-Leste</option>
                        <option value="TG">TG - Togo</option>
                        <option value="TK">TK - Tokelau</option>
                        <option value="TO">TO - Tonga</option>
                        <option value="TT">TT - Trinidad And Tobago</option>
                        <option value="TN">TN - Tunisia</option>
                        <option value="TR">TR - Turkey</option>
                        <option value="TM">TM - Turkmenistan</option>
                        <option value="TC">TC - Turks And Caicos Islands</option>
                        <option value="TV">TV - Tuvalu</option>
                        <option value="UG">UG - Uganda</option>
                        <option value="UA">UA - Ukraine</option>
                        <option value="AE">AE - United Arab Emirates</option>
                        <option value="GB">GB - United Kingdom</option>
                        <option value="US">US - United States</option>
                        <option value="UM">UM - United States Minor Outlying Islands</option>
                        <option value="UY">UY - Uruguay</option>
                        <option value="UZ">UZ - Uzbekistan</option>
                        <option value="VU">VU - Vanuatu</option>
                        <option value="VE">VE - Venezuela</option>
                        <option value="VN">VN - Vietnam</option>
                        <option value="VG">VG - British Virgin Islands</option>
                        <option value="VI">VI - U.S. Virgin Islands</option>
                        <option value="WF">WF - Wallis And Futuna</option>
                        <option value="EH">EH - Western Sahara</option>
                        <option value="YE">YE - Yemen</option>
                        <option value="ZM">ZM - Zambia</option>
                        <option value="ZW">ZW - Zimbabwe</option>
                    </select>
                </div>

                <div class="mapping-item" style="margin-bottom: 20px;">
                    <label>Supplier Account Number:</label>
                    <input type="text" id="supplierAccountNumber" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="Enter supplier account number">
                </div>

                <div class="mapping-item" style="margin-bottom: 20px;">
                    <label>Cost Price Currency:</label>
                    <select id="costPriceCurrency" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="GBP" selected>GBP</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="CAD">CAD</option>
                        <option value="AUD">AUD</option>
                    </select>
                </div>

                <div class="mapping-item" style="margin-bottom: 20px;">
                    <label>List Price Currency:</label>
                    <select id="listPriceCurrency" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="GBP" selected>GBP</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="CAD">CAD</option>
                        <option value="AUD">AUD</option>
                    </select>
                </div>

                <div class="mapping-item" style="margin-bottom: 20px;">
                    <label>Exchange Rate Value:</label>
                    <input type="number" id="exchangeRate" value="1.0" step="0.0001" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="Enter exchange rate">
                </div>

                <div class="mapping-item" style="margin-bottom: 20px;">
                    <label>Duty-free?:</label>
                    <select id="dutyFree" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="FALSE">FALSE</option>
                        <option value="TRUE" selected>TRUE</option>
                    </select>
                </div>

                <div class="mapping-item" style="margin-bottom: 20px;">
                    <label>Price List Effective Date:</label>
                    <input type="date" id="effectiveDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; cursor: pointer;" onclick="this.showPicker ? this.showPicker() : this.focus();">
                </div>

                <div class="mapping-item" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">Upload Database Export File</h3>
                    <div class="alert alert-info" style="margin-bottom: 15px; padding: 10px; background: #e7f3ff;">
                        <small style="color: #004085;">
                            üìä Upload the database export Excel file containing current product data.<br>
                            This file should include: vad_variant_code, vad_ean_code, vad_description, md_name, vasd_standard_cost, etc.
                        </small>
                    </div>
                    <div class="upload-area" id="databaseUploadArea">
                        <h2>üìä Drop database export here or click to browse</h2>
                        <p style="color: #666; margin-top: 10px;">Supports .xlsx, .xls, and .xlsm formats</p>
                        <input type="file" id="databaseExportFileInput2" accept=".xlsx,.xls,.xlsm">
                    </div>
                    <div id="databaseExportUploadMessages" style="margin: 15px 0;"></div>
                </div>

                <div class="mapping-item" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">Upload Pricing File</h3>
                    <div class="upload-area disabled" id="uploadArea">
                        <h2>üìÅ Drop file here or click to browse</h2>
                        <p style="color: #666; margin-top: 10px;">Supports .xlsx, .xls, and .csv formats</p>
                        <p style="color: #ff6b6b; margin-top: 10px; font-weight: bold;" id="uploadRequirement">‚ö†Ô∏è Please complete all required fields above first</p>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" disabled>
                    </div>
                    <div id="uploadMessages" style="margin: 15px 0;"></div>
                </div>
            </div>
        </div>

        <!-- Step 2: Map Columns -->
        <div id="step2" class="step">
            <div class="step-header">Step 2: Map Columns</div>
            <div class="alert alert-info">
                Assign each column from your uploaded file to the appropriate field using the dropdowns below each column header.
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 2px solid #007bff;">
                <strong>‚ÑπÔ∏è Column Assignment Guide:</strong>
                <div style="margin-top: 10px;">
                    <small style="color: #666;">
                        <strong>Required:</strong> Supplier Part Number + (List Price GBP OR Cost Price)<br>
                        <strong>Optional:</strong> Description, Barcode, Manufacturer, Country of Origin<br><br>
                        <strong>Next Step:</strong> Based on your mapping, Step 3 will automatically provide:<br>
                        ‚Ä¢ Discount % column (if you only have List Price GBP)<br>
                        ‚Ä¢ Markup % column (if you only have Cost Price)<br>
                        ‚Ä¢ Direct editing (if you have both Cost Price and List Price GBP)
                    </small>
                </div>
            </div>

            <div class="spreadsheet-container">
                <table class="spreadsheet" id="mappingTable"></table>
            </div>
        </div>

        <!-- Step 3: Edit Data -->
        <div id="step3" class="step">
            <div class="step-header">Step 3: Edit Data</div>
            <div class="alert alert-info" id="step3Info">
                Edit your data and apply discounts or markups as needed.
            </div>

            <div class="discount-tools" id="step3Tools">
                <strong>üí° Quick Pricing Tools:</strong><br><br>

                <div id="discountToolsSection3" style="margin-bottom: 15px; display: none;">
                    <label>üè∑Ô∏è Discount value:</label>
                    <input type="number" id="bulkDiscount3" placeholder="e.g., 20" min="0" max="100" step="0.1">
                    <button class="btn btn-success" onclick="applyDiscountToSelected()">Apply to Selected Rows</button>
                    <button class="btn" onclick="applyBulkDiscount()">Apply to All Rows</button>
                    <button class="btn btn-secondary" onclick="clearSelectedDiscounts()">Clear Selected</button>
                    <button class="btn btn-secondary" onclick="clearAllDiscounts()">Clear All</button>
                </div>

                <div id="markupToolsSection3" style="margin-bottom: 15px; display: none;">
                    <label>üìà Markup value:</label>
                    <input type="number" id="bulkMarkup3" placeholder="e.g., 25" min="0" max="1000" step="0.1">
                    <button class="btn btn-success" onclick="applyMarkupToSelected()">Apply to Selected Rows</button>
                    <button class="btn" onclick="applyBulkMarkup()">Apply to All Rows</button>
                    <button class="btn btn-secondary" onclick="clearSelectedMarkups()">Clear Selected</button>
                    <button class="btn btn-secondary" onclick="clearAllMarkups()">Clear All</button>
                </div>

                <div style="background: white; padding: 10px; border-radius: 4px; border-left: 4px solid #007bff;">
                    <strong>How to use:</strong><br>
                    <small style="color: #666;">
                        1Ô∏è‚É£ <strong>Select rows:</strong> Click row numbers below (hold Ctrl for multiple)<br>
                        2Ô∏è‚É£ <strong>Enter value:</strong> Type percentage in box above<br>
                        3Ô∏è‚É£ <strong>Apply:</strong> Click "Apply to Selected Rows" or "Apply to All Rows"<br><br>
                        <strong>Keyboard shortcuts:</strong><br>
                        ‚Ä¢ Click a cell with a value ‚Üí <strong>Ctrl+C</strong> to copy<br>
                        ‚Ä¢ Select destination rows (Ctrl+click row numbers)<br>
                        ‚Ä¢ Press <strong>Ctrl+Shift+V</strong> to paste to all selected rows
                    </small>
                </div>
            </div>

            <div class="spreadsheet-container">
                <table class="spreadsheet" id="spreadsheet"></table>
            </div>
        </div>

        <!-- Step 4: Review & Process -->
        <div id="step4" class="step">
            <div class="step-header">Step 4: Review & Process</div>

            <div class="alert alert-info">
                Review your mapped data below before processing. Make sure all columns are correctly assigned.
            </div>

            <div class="preview-table">
                <h3>Preview Mapped Data (first 10 rows):</h3>
                <table class="comparison-table" id="previewTable"></table>
            </div>
        </div>

        <!-- Step 5: Previous Price List -->
        <div id="step5" class="step">
            <div class="step-header">Step 5: Previous Price List</div>

            <div class="alert alert-info">
                <strong>Optional:</strong> Upload previous pricing data for comparison
                <input type="file" id="previousFileInput" accept=".xlsx,.xls,.csv,.json" style="display: block; margin-top: 10px;">
            </div>

            <div id="previousUploadMessages" style="margin: 15px 0;"></div>

            <div style="margin: 20px 0;">
                <button class="btn" onclick="sortPreviousPriceList('status')">Sort by Status (Missing First)</button>
                <button class="btn btn-secondary" onclick="sortPreviousPriceList('code')">Sort by Code</button>
            </div>

            <div class="spreadsheet-container">
                <table class="comparison-table" id="previousPriceTable"></table>
            </div>
        </div>

        <!-- Step 6: Original Price List -->
        <div id="step6" class="step">
            <div class="step-header">Step 6: Original Price List</div>

            <div class="alert alert-info">
                Review the original price list data with variant matching. Edit the "Description to use" field if needed.
            </div>

            <div id="batchUpdateIndicator" class="alert alert-warning" style="display: none; font-weight: bold;">
                ‚è≥ Batching updates... Table will refresh shortly to prevent crashes.
            </div>

            <div class="spreadsheet-container">
                <table class="comparison-table" id="originalPriceTable"></table>
            </div>
        </div>

        <!-- Step 7: Forex Calc -->
        <div id="step7" class="step">
            <div class="step-header">Step 7: Forex Calc - Review Changes & Flagged Items</div>
            
            <div class="stats-grid" id="statsGrid"></div>
            
            <div class="alert alert-warning" id="flaggedAlert" style="display:none;">
                <strong>‚ö†Ô∏è Attention Required:</strong> Items flagged below meet criteria: ‚â•15% increase OR ‚â§-10% decrease with cost ‚â•¬£100
            </div>
            
            <div style="margin: 20px 0;">
                <label style="margin-right: 20px;">
                    <input type="checkbox" id="showAllItems" onchange="toggleFilter()" checked>
                    Show all items
                </label>
                <label style="margin-right: 20px;">
                    <input type="checkbox" id="showOnlyFlagged" onchange="toggleFilter()">
                    Show only flagged items
                </label>
                <label>
                    <input type="checkbox" id="showOnlyNew" onchange="toggleFilter()">
                    Show only new items
                </label>
            </div>
            
            <div class="spreadsheet-container">
                <table class="comparison-table" id="comparisonTable"></table>
            </div>
        </div>

        <!-- Step 8: OW Import Sheet -->
        <div id="step8" class="step">
            <div class="step-header">Step 8: OW Import Sheet</div>

            <div class="alert alert-info">
                Review the data formatted for OrderWise import. The following columns have been populated:<br>
                <strong>Supplier, Suppliers Part Code, Description, Cost Price, List Price, Retro %, Serial Tracked?, Price List Name, EAN Code, Manufacturer, Main Supplier</strong>
            </div>

            <div class="spreadsheet-container">
                <table class="comparison-table" id="owImportTable"></table>
            </div>

            <div class="button-group">
                <button class="btn" onclick="exportOWImportExcel()">üì• Export OW Import Front Sheet</button>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let previousData = [];
        let databaseExportData = []; // Store database export data for comparison
        let commodityCodeData = []; // Store commodity codes from database 'commodity codes' sheet
        let processedData = [];
        let columnMapping = {};
        let currentStep = 1;
        let selectedRows = new Set();
        let copiedValue = null;
        let excludedRows = new Set();
        let descriptionToUseMap = {}; // Store "Description to use" values by product code
        let barcodeToUseMap = {}; // Store "Barcode to use" values by row index
        let commodityCodeToUseMap = {}; // Store "Commodity Code to use" values by row index
        let countryCodeToUseMap = {}; // Store "Country Code to use" values by row index
        let renderDebounceTimer = null; // Debounce timer for renders
        let excludeDebounceTimer = null; // Debounce timer for exclude/restore operations
        let previousPriceListData = []; // Store previous price list with status for sorting
        let columnWidths = {}; // Store custom column widths by table ID
        let isScrolling = false; // Track if user is currently scrolling
        let scrollTimer = null; // Timer to detect end of scrolling
        let pendingRender = null; // Store pending render function to execute after scroll
        let previousDataMap = null; // Cached lookup map for previousData (performance optimization)
        let databaseExportDataMap = null; // Cached lookup map for databaseExportData (performance optimization)
        let commodityCodeMap = null; // Cached lookup map for commodity codes (performance optimization)
        let pendingUpdateCount = 0; // Track number of pending updates for adaptive debouncing
        let lastUpdateTime = 0; // Track last update time to detect rapid clicking

        // Settings data
        let settings = {
            manufacturerName: '',
            supplierAccountNumber: '',
            effectiveDate: '',
            region: 'GB',
            defaultCOO: '',
            costPriceCurrency: 'GBP',
            listPriceCurrency: 'GBP',
            exchangeRate: 1.0,
            dutyFree: 'TRUE'
        };
        
        const REQUIRED_FIELDS = ['code', 'listPrice'];
        const OPTIONAL_FIELDS = ['description', 'barcode', 'costPrice', 'discount'];

        // Check if required settings fields are filled
        function checkRequiredSettings() {
            const manufacturerName = document.getElementById('manufacturerName').value.trim();
            const supplierAccountNumber = document.getElementById('supplierAccountNumber').value.trim();
            const effectiveDate = document.getElementById('effectiveDate').value;

            return manufacturerName && supplierAccountNumber && effectiveDate;
        }

        // Enable or disable upload area based on required settings
        function updateUploadAreaState() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadRequirement = document.getElementById('uploadRequirement');

            if (checkRequiredSettings()) {
                uploadArea.classList.remove('disabled');
                fileInput.disabled = false;
                if (uploadRequirement) {
                    uploadRequirement.style.display = 'none';
                }
            } else {
                uploadArea.classList.add('disabled');
                fileInput.disabled = true;
                if (uploadRequirement) {
                    uploadRequirement.style.display = 'block';
                }
            }
        }

        // Build previousData lookup map for O(1) access (performance optimization)
        function buildPreviousDataMap() {
            previousDataMap = new Map();
            if (previousData && previousData.length > 0) {
                previousData.forEach(item => {
                    const code = (item.code || item.productcode || '').toLowerCase();
                    if (code) {
                        previousDataMap.set(code, item);
                    }
                });
            }
        }

        // Build databaseExportData lookup map for O(1) access (performance optimization)
        function buildDatabaseExportDataMap() {
            databaseExportDataMap = new Map();
            if (databaseExportData && databaseExportData.length > 0) {
                databaseExportData.forEach(item => {
                    const code = (item.vad_variant_code || '').toString().toLowerCase();
                    if (code) {
                        databaseExportDataMap.set(code, item);
                    }
                    // Also map by barcode for additional lookup
                    const barcode = (item.vad_ean_code || '').toString().toLowerCase();
                    if (barcode) {
                        databaseExportDataMap.set(`barcode_${barcode}`, item);
                    }
                });
            }
        }

        function buildCommodityCodeMap() {
            commodityCodeMap = new Map();
            if (commodityCodeData && commodityCodeData.length > 0) {
                commodityCodeData.forEach(item => {
                    // Expected columns: Commodity Codes, Duty Rate, Country Code, Category
                    // Get the commodity code from first column (normalize to string and trim)
                    const code = (item['Commodity Codes'] || item['Commodity Code'] || '').toString().trim();
                    // Get the category from fourth column
                    const category = (item['Category'] || '').toString().trim();

                    if (code) {
                        // Store the full item so we can access all fields if needed
                        commodityCodeMap.set(code, {
                            code: code,
                            dutyRate: item['Duty Rate'] || '',
                            countryCode: item['Country Code'] || '',
                            category: category
                        });
                    }
                });
            }
        }

        // Safe render wrapper - defers render if user is scrolling
        function safeRender(renderFunction) {
            if (isScrolling) {
                // Store the render to execute after scrolling stops
                pendingRender = renderFunction;
            } else {
                // Safe to render now
                renderFunction();
            }
        }

        // Column resize functionality
        function makeColumnsResizable(table) {
            const tableId = table.id;
            if (!tableId) return; // Skip if table has no ID

            // Initialize storage for this table if it doesn't exist
            if (!columnWidths[tableId]) {
                columnWidths[tableId] = {};
            }

            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                // Restore saved width if it exists
                if (columnWidths[tableId][index]) {
                    const width = columnWidths[tableId][index];
                    header.style.width = width + 'px';
                    header.style.minWidth = width + 'px';
                    header.style.maxWidth = width + 'px';
                }

                // Check if resizer already exists to prevent duplicates
                if (header.querySelector('.column-resizer')) {
                    return; // Resizer already exists, skip
                }

                const resizer = document.createElement('div');
                resizer.className = 'column-resizer';
                header.style.position = 'relative';
                header.appendChild(resizer);

                let startX, startWidth;

                resizer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    startX = e.pageX;
                    startWidth = header.offsetWidth;

                    const onMouseMove = (e) => {
                        const width = startWidth + (e.pageX - startX);
                        if (width > 30) { // Minimum width
                            header.style.width = width + 'px';
                            header.style.minWidth = width + 'px';
                            header.style.maxWidth = width + 'px';
                            // Save the width
                            columnWidths[tableId][index] = width;
                        }
                    };

                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });
        }

        // Add event listeners to required settings fields
        document.addEventListener('DOMContentLoaded', () => {
            const manufacturerNameInput = document.getElementById('manufacturerName');
            const supplierAccountNumberInput = document.getElementById('supplierAccountNumber');
            const effectiveDateInput = document.getElementById('effectiveDate');

            manufacturerNameInput.addEventListener('input', updateUploadAreaState);
            supplierAccountNumberInput.addEventListener('input', updateUploadAreaState);
            effectiveDateInput.addEventListener('change', updateUploadAreaState);

            // Initial check
            updateUploadAreaState();

            // Add scroll event listener to prevent renders during scrolling
            window.addEventListener('scroll', () => {
                isScrolling = true;

                // Clear existing timer
                if (scrollTimer) {
                    clearTimeout(scrollTimer);
                }

                // Set timer to detect when scrolling stops
                scrollTimer = setTimeout(() => {
                    isScrolling = false;

                    // If there's a pending render, execute it now
                    if (pendingRender) {
                        const renderFn = pendingRender;
                        pendingRender = null;
                        renderFn();
                    }
                }, 200); // 200ms after scroll stops
            }, { passive: true });
        });

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previousFileInput = document.getElementById('previousFileInput');
        const databaseUploadArea = document.getElementById('databaseUploadArea');
        const databaseExportFileInput2 = document.getElementById('databaseExportFileInput2');

        // Database export upload area event handlers
        databaseUploadArea.addEventListener('click', () => {
            databaseExportFileInput2.click();
        });

        databaseUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            databaseUploadArea.classList.add('dragover');
        });

        databaseUploadArea.addEventListener('dragleave', () => {
            databaseUploadArea.classList.remove('dragover');
        });

        databaseUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            databaseUploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleDatabaseExportFile(file);
        });

        databaseExportFileInput2.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleDatabaseExportFile(file);
        });

        // Pricing file upload area event handlers
        uploadArea.addEventListener('click', () => {
            if (!uploadArea.classList.contains('disabled')) {
                fileInput.click();
            }
        });

        uploadArea.addEventListener('dragover', (e) => {
            if (!uploadArea.classList.contains('disabled')) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            }
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (!uploadArea.classList.contains('disabled')) {
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        previousFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handlePreviousFile(file);
        });

        function handleFile(file) {
            const reader = new FileReader();
            const isCSV = file.name.toLowerCase().endsWith('.csv');

            reader.onload = (e) => {
                let jsonData;

                if (isCSV) {
                    // Handle CSV files
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    jsonData = lines.map(line => {
                        // Simple CSV parsing - handles quoted fields
                        const result = [];
                        let current = '';
                        let inQuotes = false;

                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                result.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        result.push(current.trim());
                        return result;
                    });
                } else {
                    // Handle Excel files
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1, defval: ''});
                }

                currentData = jsonData.filter(row => row.some(cell => cell !== ''));

                if (currentData.length > 0) {
                    showUploadMessage('‚úì File uploaded successfully! Automatically proceeding to Map Columns...', 'success');
                    // Automatically proceed to mapping step after brief delay
                    setTimeout(() => {
                        proceedFromUpload();
                    }, 1000);
                }
            };

            if (isCSV) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function proceedFromUpload() {
            if (currentData.length > 0) {
                renderMappingTable();
                goToStep(2);
            }
        }

        function validateSettings() {
            // Get settings values
            settings.manufacturerName = document.getElementById('manufacturerName').value.trim();
            settings.supplierAccountNumber = document.getElementById('supplierAccountNumber').value.trim();
            settings.effectiveDate = document.getElementById('effectiveDate').value;
            settings.region = document.getElementById('region').value;
            settings.defaultCOO = document.getElementById('defaultCOO').value;
            settings.costPriceCurrency = document.getElementById('costPriceCurrency').value;
            settings.listPriceCurrency = document.getElementById('listPriceCurrency').value;
            settings.exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 1.0;
            settings.dutyFree = document.getElementById('dutyFree').value;

            // Validate required fields
            if (!settings.manufacturerName) {
                alert('Please enter the manufacturer or brand name');
                return;
            }

            if (!settings.supplierAccountNumber) {
                alert('Please enter the supplier account number');
                return;
            }

            if (!settings.effectiveDate) {
                alert('Please select the price list effective date');
                return;
            }

            // Proceed to Map Columns step
            goToStep(2);
        }
        
        function handlePreviousFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                if (file.name.endsWith('.json')) {
                    previousData = JSON.parse(e.target.result);
                    buildPreviousDataMap(); // Build lookup map for performance
                    showUploadMessage('‚úì Previous pricing data loaded successfully! Review the data below.', 'success', 'previousUploadMessages');
                } else {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1, defval: ''});

                    // Assume first row is headers, convert to objects
                    const headers = jsonData[0];
                    previousData = jsonData.slice(1).map(row => {
                        let obj = {};
                        headers.forEach((header, i) => {
                            obj[header.toLowerCase().replace(/\s+/g, '')] = row[i];
                        });
                        return obj;
                    });
                    buildPreviousDataMap(); // Build lookup map for performance
                    showUploadMessage('‚úì Previous pricing data loaded successfully! Review the data below.', 'success', 'previousUploadMessages');
                }

                // Automatically update Previous Price List display
                setTimeout(() => {
                    renderPreviousPriceList();
                }, 1000);
            };

            if (file.name.endsWith('.json')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function handleDatabaseExportFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1, defval: ''});

                // Assume first row is headers, convert to objects
                const headers = jsonData[0];
                databaseExportData = jsonData.slice(1).map(row => {
                    let obj = {};
                    headers.forEach((header, i) => {
                        // Keep original header names for database export
                        obj[header] = row[i];
                    });
                    return obj;
                });
                buildDatabaseExportDataMap(); // Build lookup map for performance

                // Also load the "commodity codes" sheet if it exists
                const commoditySheetName = workbook.SheetNames.find(name =>
                    name.toLowerCase() === 'commodity codes'
                );

                if (commoditySheetName) {
                    const commoditySheet = workbook.Sheets[commoditySheetName];
                    const commodityJsonData = XLSX.utils.sheet_to_json(commoditySheet, {header: 1, defval: ''});

                    // Expected columns: Commodity Codes, Duty Rate, Country Code, Category
                    const commodityHeaders = commodityJsonData[0];
                    commodityCodeData = commodityJsonData.slice(1).map(row => {
                        let obj = {};
                        commodityHeaders.forEach((header, i) => {
                            obj[header] = row[i];
                        });
                        return obj;
                    });
                    buildCommodityCodeMap(); // Build lookup map for performance
                    console.log('Commodity codes loaded:', commodityCodeData.length, 'codes');
                    showUploadMessage(`‚úì Database export loaded successfully! (${databaseExportData.length} records, ${commodityCodeData.length} commodity codes)`, 'success', 'databaseExportUploadMessages');
                } else {
                    console.log('No "commodity codes" sheet found in database export');
                    showUploadMessage(`‚úì Database export loaded successfully! (${databaseExportData.length} records)`, 'success', 'databaseExportUploadMessages');
                }

                console.log('Database export loaded:', databaseExportData.length, 'records');
            };

            reader.readAsArrayBuffer(file);
        }

        function showUploadMessage(message, type = 'success', targetDiv = 'uploadMessages') {
            const messagesDiv = document.getElementById(targetDiv);
            const messageClass = type === 'success' ? 'alert alert-info' : 'alert alert-warning';
            messagesDiv.innerHTML = `<div class="${messageClass}" style="animation: fadeIn 0.3s;">${message}</div>`;
        }

        function renderMappingTable() {
            // Step 2: Show only column headers and mapping dropdowns (no data editing)
            const table = document.getElementById('mappingTable');
            table.innerHTML = '';

            // Header row with column names
            const headerRow = document.createElement('tr');
            let headerHTML = '<th class="row-number">#</th>';
            currentData[0].forEach((cell, i) => {
                headerHTML += `<th class="column-header-cell">
                    <span class="column-header-text">${cell || `Column ${String.fromCharCode(65 + i)}`}</span>
                </th>`;
            });
            headerRow.innerHTML = headerHTML;
            table.appendChild(headerRow);

            // Mapping row with dropdowns
            const mappingRow = document.createElement('tr');
            let mappingHTML = '<th class="row-number" style="background: #e3f2fd;">Map to:</th>';

            const fieldOptions = [
                {value: '', label: '-- Ignore Column --'},
                {value: 'code', label: 'üì¶ Supplier Part Number *'},
                {value: 'description', label: 'üìù Description'},
                {value: 'costPrice', label: 'üí∞ Cost Price'},
                {value: 'listPrice', label: 'üí∑ List Price GBP'},
                {value: 'discount', label: 'üè∑Ô∏è Discount %'},
                {value: 'markup', label: 'üìà Markup %'},
                {value: 'barcode', label: 'üî¢ Barcode'},
                {value: 'manufacturer', label: 'üè≠ Manufacturer'},
                {value: 'countryOfOrigin', label: 'üåç Country of Origin'},
                {value: 'commodityCode', label: 'üìã Commodity Code'}
            ];

            currentData[0].forEach((header, colIndex) => {
                // No auto-detection - all columns default to "Ignore"
                mappingHTML += `<th style="background: #e3f2fd; padding: 8px;">
                    <select id="colMap_${colIndex}" class="column-mapping-select" onchange="updateColumnMapping()">
                        ${fieldOptions.map(opt =>
                            `<option value="${opt.value}">${opt.label}</option>`
                        ).join('')}
                    </select>
                </th>`;
            });
            mappingRow.innerHTML = mappingHTML;
            table.appendChild(mappingRow);

            // Show first 5 rows as preview
            for (let rowIndex = 1; rowIndex <= Math.min(5, currentData.length - 1); rowIndex++) {
                const row = currentData[rowIndex];
                const tr = document.createElement('tr');
                let rowHTML = `<td class="row-number">${rowIndex}</td>`;
                for (let colIndex = 0; colIndex < currentData[0].length; colIndex++) {
                    const cell = row[colIndex] || '';
                    rowHTML += `<td style="color: #666;">${cell}</td>`;
                }
                tr.innerHTML = rowHTML;
                table.appendChild(tr);
            }

            // Initialize mapping
            updateColumnMapping();

            // Make columns resizable
            makeColumnsResizable(table);
        }

        function validateMapping() {
            // Validate required mappings
            if (columnMapping.code === undefined) {
                alert('Please map the required field: Supplier Part Number');
                return;
            }

            // Need at least one price field
            if (columnMapping.listPrice === undefined && columnMapping.costPrice === undefined) {
                alert('Please map at least one price field: either List Price OR Cost Price');
                return;
            }

            // Prepare Step 3 with appropriate discount/markup column
            prepareStep3();
            goToStep(3);
        }

        function prepareStep3() {
            // Based on mapping, add discount % or markup % column if needed
            const hasListPrice = columnMapping.listPrice !== undefined;
            const hasCostPrice = columnMapping.costPrice !== undefined;

            let infoMessage = '';
            let addedColumn = false;

            if (hasListPrice && !hasCostPrice) {
                // Only have list price - add discount % column
                const columnName = 'Discount %';
                if (!currentData[0].includes(columnName)) {
                    currentData[0].push(columnName);
                    for (let i = 1; i < currentData.length; i++) {
                        currentData[i].push('');
                    }
                    addedColumn = true;
                }
                columnMapping.discount = currentData[0].indexOf(columnName);
                infoMessage = 'A <strong>Discount %</strong> column has been added. Enter discount percentages to calculate cost prices from list prices.';
            } else if (hasCostPrice && !hasListPrice) {
                // Only have cost price - add markup % column
                const columnName = 'Markup %';
                if (!currentData[0].includes(columnName)) {
                    currentData[0].push(columnName);
                    for (let i = 1; i < currentData.length; i++) {
                        currentData[i].push('');
                    }
                    addedColumn = true;
                }
                columnMapping.markup = currentData[0].indexOf(columnName);
                infoMessage = 'A <strong>Markup %</strong> column has been added. Enter markup percentages to calculate list prices from cost prices.';
            } else {
                // Have both prices
                infoMessage = 'You have both Cost Price and List Price columns. Edit your data as needed below.';
            }

            document.getElementById('step3Info').innerHTML = infoMessage;
        }

        function getMappedColumnIndices() {
            // Define the desired column order
            const columnOrder = ['code', 'description', 'costPrice', 'discount', 'listPrice', 'markup', 'barcode', 'manufacturer', 'countryOfOrigin', 'commodityCode'];

            const mappedIndices = [];

            // Add columns in the desired order
            columnOrder.forEach(fieldName => {
                if (columnMapping[fieldName] !== undefined) {
                    mappedIndices.push(columnMapping[fieldName]);
                }
            });

            return mappedIndices;
        }

        function findDuplicateCodes() {
            const duplicates = new Set();
            const codeCol = columnMapping.code;

            if (codeCol === undefined) return duplicates;

            const codeCounts = {};

            // Count occurrences of each code (case-insensitive, skip excluded rows)
            for (let rowIndex = 1; rowIndex < currentData.length; rowIndex++) {
                if (excludedRows.has(rowIndex)) continue;

                const code = currentData[rowIndex][codeCol];
                if (code) {
                    const normalizedCode = code.toString().toLowerCase();
                    codeCounts[normalizedCode] = (codeCounts[normalizedCode] || 0) + 1;
                }
            }

            // Find codes that appear more than once
            for (const [code, count] of Object.entries(codeCounts)) {
                if (count > 1) {
                    duplicates.add(code);
                }
            }

            return duplicates;
        }

        function renderSpreadsheet() {
            const table = document.getElementById('spreadsheet');
            table.innerHTML = '';

            // Get only mapped columns (ignore columns that are not mapped)
            const mappedIndices = getMappedColumnIndices();

            // Check if discount or markup columns are mapped
            const hasDiscount = columnMapping.discount !== undefined;
            const hasMarkup = columnMapping.markup !== undefined;

            // Show/hide quick tools based on mapping
            document.getElementById('discountToolsSection3').style.display = hasDiscount ? 'block' : 'none';
            document.getElementById('markupToolsSection3').style.display = hasMarkup ? 'block' : 'none';
            document.getElementById('step3Tools').style.display = (hasDiscount || hasMarkup) ? 'block' : 'none';

            // Find duplicate codes
            const duplicateCodes = findDuplicateCodes();

            // Header row with column names (only mapped columns)
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `<th class="row-number" style="text-align: center;">#</th><th>${settings.manufacturerName} - ${settings.supplierAccountNumber}</th>`;

            // Map field names to display names
            const fieldDisplayNames = {
                'code': 'Supplier Part Number',
                'description': 'Description',
                'costPrice': 'Cost Price',
                'discount': 'Discount %',
                'listPrice': 'List Price GBP',
                'markup': 'Markup %',
                'barcode': 'Barcode',
                'manufacturer': 'Manufacturer',
                'countryOfOrigin': 'Country of Origin',
                'commodityCode': 'Commodity Code'
            };

            let headerHTML = '';
            mappedIndices.forEach(i => {
                // Find which field this column is mapped to
                const fieldName = Object.keys(columnMapping).find(key => columnMapping[key] === i);
                const displayName = fieldDisplayNames[fieldName] || currentData[0][i];

                const isDiscountCol = columnMapping.discount === i;
                const isMarkupCol = columnMapping.markup === i;
                const isFlexCol = isDiscountCol || isMarkupCol;
                headerHTML += `<th class="column-header-cell" style="${isFlexCol ? 'background: #fff3cd;' : ''}">
                    <span class="column-header-text">${displayName}</span>
                </th>`;
            });
            headerRow.innerHTML += headerHTML;
            table.appendChild(headerRow);

            // Data rows
            for (let rowIndex = 1; rowIndex < currentData.length; rowIndex++) {
                const row = currentData[rowIndex];
                const tr = document.createElement('tr');
                const isExcluded = excludedRows.has(rowIndex);
                tr.className = isExcluded ? 'excluded-row' : '';

                // Get the code to look up in database export data
                const code = columnMapping.code !== undefined ? row[columnMapping.code] : '';
                let previousDescription = '';
                let prevDescBg = '';

                if (code) {
                    // Check if this item exists in database export data (O(1) lookup)
                    const dbItem = databaseExportDataMap ? databaseExportDataMap.get(code.toLowerCase()) : null;

                    if (dbItem) {
                        // Found in database
                        previousDescription = dbItem.vad_description || '-';
                        prevDescBg = '#90EE90'; // Bright green - exists in database
                    } else {
                        // New product (not in database)
                        previousDescription = 'New product? Check if new';
                        prevDescBg = '#FFFF00'; // Bright yellow - not in database
                    }
                } else {
                    previousDescription = '-';
                }

                // Build row HTML in a string first
                let rowHTML = `<td class="row-number" style="cursor: pointer; text-align: center;" onclick="toggleRowExclusion(${rowIndex})" title="${isExcluded ? 'Click to restore row' : 'Click to exclude row'}">
                    ${isExcluded ? '‚ùå' : rowIndex}
                </td><td style="background: ${prevDescBg};">${previousDescription}</td>`;

                mappedIndices.forEach(colIndex => {
                    const cell = row[colIndex] || '';
                    const isDiscountCol = columnMapping.discount === colIndex;
                    const isMarkupCol = columnMapping.markup === colIndex;
                    const isFlexCol = isDiscountCol || isMarkupCol;
                    const isCodeCol = columnMapping.code === colIndex;
                    const isDuplicate = isCodeCol && cell && duplicateCodes.has(cell.toString().toLowerCase());

                    let bgColor = '';
                    if (isDuplicate) {
                        bgColor = '#ffcccc'; // Red for duplicates
                    } else if (isFlexCol) {
                        bgColor = '#fff3cd';
                    }

                    const cellStyle = bgColor ? `background: ${bgColor};` : '';
                    const inputStyle = bgColor ? `background: ${bgColor};` : '';

                    rowHTML += `<td style="${cellStyle}"><input type="text"
                        value="${cell}"
                        onchange="updateCell(${rowIndex}, ${colIndex}, this.value)"
                        onkeydown="handleKeyDown(event, ${rowIndex}, ${colIndex})"
                        onfocus="handleFocus(${rowIndex}, ${colIndex})"
                        style="${inputStyle}"
                        placeholder="${isFlexCol ? '0' : ''}"></td>`;
                });

                tr.innerHTML = rowHTML;
                table.appendChild(tr);
            }

            // Make columns resizable
            makeColumnsResizable(table);
        }

        function updateColumnMapping() {
            columnMapping = {};
            
            currentData[0].forEach((header, colIndex) => {
                const select = document.getElementById(`colMap_${colIndex}`);
                if (select && select.value) {
                    columnMapping[select.value] = colIndex;
                }
            });
        }
        
        function renderColumnMapping() {
            // This function is no longer needed - mapping is in the table
        }
        
        function toggleRowSelection(rowIndex, event) {
            if (rowIndex === 0) return; // Don't select header
            
            if (event.ctrlKey || event.metaKey) {
                if (selectedRows.has(rowIndex)) {
                    selectedRows.delete(rowIndex);
                } else {
                    selectedRows.add(rowIndex);
                }
            } else {
                selectedRows.clear();
                selectedRows.add(rowIndex);
            }
            renderSpreadsheet();
        }
        
        function toggleAllRows() {
            if (selectedRows.size === currentData.length - 1) {
                selectedRows.clear();
            } else {
                selectedRows.clear();
                for (let i = 1; i < currentData.length; i++) {
                    selectedRows.add(i);
                }
            }
            renderSpreadsheet();
        }
        
        function handleKeyDown(event, row, col) {
            // Get the mapped discount column index
            const discountColIndex = columnMapping.discount;
            
            // Copy (Ctrl+C)
            if ((event.ctrlKey || event.metaKey) && event.key === 'c') {
                copiedValue = event.target.value;
                event.target.style.background = '#ffffcc';
                setTimeout(() => {
                    event.target.style.background = col === discountColIndex ? '#d4edda' : '';
                }, 200);
            }
            
            // Paste to single cell (Ctrl+V)
            if ((event.ctrlKey || event.metaKey) && event.key === 'v' && !event.shiftKey && copiedValue !== null) {
                event.preventDefault();
                event.target.value = copiedValue;
                updateCell(row, col, copiedValue);
            }
            
            // Paste to all selected rows (Ctrl+Shift+V) - only works for discount/markup columns
            if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key.toLowerCase() === 'v' && copiedValue !== null) {
                event.preventDefault();
                if (selectedRows.size === 0) {
                    alert('Please select rows first (Ctrl+click row numbers)');
                    return;
                }

                // Determine which column to paste to based on current cell
                let targetColIndex = discountColIndex;
                if (columnMapping.markup === col) {
                    targetColIndex = columnMapping.markup;
                }

                if (targetColIndex === undefined) {
                    alert('Bulk paste only works for Discount % or Markup % columns');
                    return;
                }

                selectedRows.forEach(rowIndex => {
                    if (rowIndex > 0) { // Skip header
                        // Ensure row has enough columns
                        while (currentData[rowIndex].length <= targetColIndex) {
                            currentData[rowIndex].push('');
                        }
                        currentData[rowIndex][targetColIndex] = copiedValue;
                    }
                });

                renderSpreadsheet();
                alert(`Pasted "${copiedValue}" to ${selectedRows.size} selected rows`);
            }
            
            // Arrow key navigation
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter'].includes(event.key)) {
                event.preventDefault();
                let newRow = row;
                let newCol = col;
                
                if (event.key === 'ArrowUp') newRow = Math.max(1, row - 1);
                if (event.key === 'ArrowDown' || event.key === 'Enter') newRow = Math.min(currentData.length - 1, row + 1);
                if (event.key === 'ArrowLeft') newCol = Math.max(0, col - 1);
                if (event.key === 'ArrowRight') newCol = Math.min(currentData[0].length - 1, col + 1);
                
                const table = document.getElementById('spreadsheet');
                const targetInput = table.rows[newRow].cells[newCol + 1].querySelector('input');
                if (targetInput && !targetInput.readOnly) {
                    targetInput.focus();
                    targetInput.select();
                }
            }
        }
        
        function handleFocus(row, col) {
            // Auto-select text for easy overwriting
            event.target.select();
        }
        
        function applyBulkDiscount() {
            const discount = document.getElementById('bulkDiscount3').value;
            if (!discount) {
                alert('Please enter a discount percentage');
                return;
            }

            // Get the mapped discount column index
            const discountColIndex = columnMapping.discount;
            if (discountColIndex === undefined) {
                alert('Error: No column is mapped to Discount %. Please map a column first.');
                return;
            }

            for (let i = 1; i < currentData.length; i++) {
                // Ensure row has enough columns
                while (currentData[i].length <= discountColIndex) {
                    currentData[i].push('');
                }
                currentData[i][discountColIndex] = discount;
            }
            renderSpreadsheet();
            alert(`Applied ${discount}% discount to all ${currentData.length - 1} rows`);
        }

        function applyDiscountToSelected() {
            const discount = document.getElementById('bulkDiscount3').value;
            if (!discount) {
                alert('Please enter a discount percentage');
                return;
            }

            if (selectedRows.size === 0) {
                alert('Please select rows first by clicking the row numbers (hold Ctrl to select multiple)');
                return;
            }

            // Get the mapped discount column index
            const discountColIndex = columnMapping.discount;
            if (discountColIndex === undefined) {
                alert('Error: No column is mapped to Discount %. Please map a column first.');
                return;
            }

            selectedRows.forEach(rowIndex => {
                // Ensure row has enough columns
                while (currentData[rowIndex].length <= discountColIndex) {
                    currentData[rowIndex].push('');
                }
                currentData[rowIndex][discountColIndex] = discount;
            });

            renderSpreadsheet();
            alert(`Applied ${discount}% discount to ${selectedRows.size} selected rows`);
        }

        function clearAllDiscounts() {
            if (!confirm('Clear all discount values?')) return;

            const discountColIndex = columnMapping.discount;
            if (discountColIndex === undefined) return;

            for (let i = 1; i < currentData.length; i++) {
                if (currentData[i][discountColIndex] !== undefined) {
                    currentData[i][discountColIndex] = '';
                }
            }
            renderSpreadsheet();
        }
        
        function clearSelectedDiscounts() {
            if (selectedRows.size === 0) {
                alert('Please select rows first by clicking the row numbers');
                return;
            }

            if (!confirm(`Clear discount values for ${selectedRows.size} selected rows?`)) return;

            const discountColIndex = columnMapping.discount;
            if (discountColIndex === undefined) return;

            selectedRows.forEach(rowIndex => {
                if (currentData[rowIndex][discountColIndex] !== undefined) {
                    currentData[rowIndex][discountColIndex] = '';
                }
            });
            renderSpreadsheet();
        }

        function applyMarkupToSelected() {
            const markup = document.getElementById('bulkMarkup3').value;
            if (!markup) {
                alert('Please enter a markup percentage');
                return;
            }

            if (selectedRows.size === 0) {
                alert('Please select rows first by clicking row numbers (hold Ctrl to select multiple)');
                return;
            }

            const markupColIndex = columnMapping.markup;

            if (markupColIndex === undefined) {
                alert('Error: No column is mapped to Markup %. Please map a column first.');
                return;
            }

            selectedRows.forEach(rowIndex => {
                while (currentData[rowIndex].length <= markupColIndex) {
                    currentData[rowIndex].push('');
                }
                currentData[rowIndex][markupColIndex] = markup;
            });

            renderSpreadsheet();
            alert(`Applied ${markup}% markup to ${selectedRows.size} selected rows`);
        }

        function applyBulkMarkup() {
            const markup = document.getElementById('bulkMarkup3').value;
            if (!markup) {
                alert('Please enter a markup percentage');
                return;
            }

            const markupColIndex = columnMapping.markup;

            if (markupColIndex === undefined) {
                alert('Error: No column is mapped to Markup %. Please map a column first.');
                return;
            }

            for (let i = 1; i < currentData.length; i++) {
                while (currentData[i].length <= markupColIndex) {
                    currentData[i].push('');
                }
                currentData[i][markupColIndex] = markup;
            }
            renderSpreadsheet();
            alert(`Applied ${markup}% markup to all ${currentData.length - 1} rows`);
        }

        function clearSelectedMarkups() {
            if (selectedRows.size === 0) {
                alert('Please select rows first by clicking row numbers');
                return;
            }

            if (!confirm(`Clear markup values for ${selectedRows.size} selected rows?`)) return;

            const markupColIndex = columnMapping.markup;
            if (markupColIndex === undefined) return;

            selectedRows.forEach(rowIndex => {
                if (currentData[rowIndex][markupColIndex] !== undefined) {
                    currentData[rowIndex][markupColIndex] = '';
                }
            });
            renderSpreadsheet();
        }

        function clearAllMarkups() {
            if (!confirm('Clear all markup values?')) return;

            const markupColIndex = columnMapping.markup;
            if (markupColIndex === undefined) return;

            for (let i = 1; i < currentData.length; i++) {
                if (currentData[i][markupColIndex] !== undefined) {
                    currentData[i][markupColIndex] = '';
                }
            }
            renderSpreadsheet();
        }
        
        function updateCell(row, col, value) {
            // Store old value for barcode/commodity code update logic
            const oldValue = currentData[row][col];

            currentData[row][col] = value;

            // If barcode column was edited, update barcodeToUseMap if user had selected the new barcode
            if (columnMapping.barcode === col) {
                // Check if user had selected to use the new barcode (not the previous barcode)
                if (barcodeToUseMap[row] === oldValue) {
                    // User had selected the new barcode, so update it to the new value
                    barcodeToUseMap[row] = value;
                }
            }

            // If commodity code column was edited, update commodityCodeToUseMap if user had selected the new commodity code
            if (columnMapping.commodityCode === col) {
                // Check if user had selected to use the new commodity code (not the previous commodity code)
                if (commodityCodeToUseMap[row] === oldValue) {
                    // User had selected the new commodity code, so update it to the new value
                    commodityCodeToUseMap[row] = value;
                }
            }

            // If country code column was edited, update countryCodeToUseMap if user had selected the new country code
            if (columnMapping.countryOfOrigin === col) {
                // Check if user had selected to use the new country code (not the previous country code)
                if (countryCodeToUseMap[row] === oldValue) {
                    // User had selected the new country code, so update it to the new value
                    countryCodeToUseMap[row] = value;
                }
            }

            // Re-render if code column was edited to update duplicate highlighting
            if (columnMapping.code === col) {
                renderSpreadsheet();
            }
        }
        
        function deleteColumn(colIndex) {
            const colName = currentData[0][colIndex];
            if (!confirm(`Delete the "${colName}" column and all its data?`)) return;
            
            // Remove column from all rows
            for (let i = 0; i < currentData.length; i++) {
                currentData[i].splice(colIndex, 1);
            }
            
            // Clear the mapping for this column
            updateColumnMapping();
            renderSpreadsheet();
            alert(`"${colName}" column deleted`);
        }
        
        function toggleRowExclusion(rowIndex) {
            // Update state immediately
            if (excludedRows.has(rowIndex)) {
                excludedRows.delete(rowIndex);
            } else {
                excludedRows.add(rowIndex);
            }

            // Debounce re-render to prevent browser crashes from rapid clicking
            if (excludeDebounceTimer) {
                clearTimeout(excludeDebounceTimer);
            }
            excludeDebounceTimer = setTimeout(() => {
                // Re-render current view (Step 3 or Step 6) - wrapped in safeRender
                safeRender(() => {
                    if (currentStep === 3) {
                        renderSpreadsheet();
                    } else if (currentStep === 6) {
                        renderOriginalPriceList();
                    }
                });
                excludeDebounceTimer = null;
            }, 250); // 250ms debounce - batches rapid clicks while still feeling responsive
        }

        function deleteRow(rowIndex) {
            // Deprecated - keeping for backward compatibility
            toggleRowExclusion(rowIndex);
        }
        
        function goToStep(step) {
            // Wait for any pending debounce timers to complete before changing steps
            const hasPendingTimers = excludeDebounceTimer || renderDebounceTimer;

            if (hasPendingTimers) {
                // Store the target step and retry after a short delay
                setTimeout(() => goToStep(step), 150);
                return;
            }

            // Validate settings and file upload before allowing navigation past step 1
            if (step > 1 && currentStep === 1) {
                // Get settings values
                const manufacturerName = document.getElementById('manufacturerName').value.trim();
                const supplierAccountNumber = document.getElementById('supplierAccountNumber').value.trim();
                const effectiveDate = document.getElementById('effectiveDate').value;

                // Check required fields
                if (!manufacturerName) {
                    alert('Please enter the manufacturer or brand name before proceeding');
                    return;
                }
                if (!supplierAccountNumber) {
                    alert('Please enter the supplier account number before proceeding');
                    return;
                }
                if (!effectiveDate) {
                    alert('Please select the price list effective date before proceeding');
                    return;
                }
                if (!currentData || currentData.length === 0) {
                    alert('Please upload a pricing file before proceeding');
                    return;
                }

                // Save settings
                settings.manufacturerName = manufacturerName;
                settings.supplierAccountNumber = supplierAccountNumber;
                settings.effectiveDate = effectiveDate;
                settings.region = document.getElementById('region').value;
                settings.defaultCOO = document.getElementById('defaultCOO').value;
                settings.costPriceCurrency = document.getElementById('costPriceCurrency').value;
                settings.listPriceCurrency = document.getElementById('listPriceCurrency').value;
                settings.exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 1.0;
                settings.dutyFree = document.getElementById('dutyFree').value;
            }

            // Validate column mapping before allowing navigation past step 2
            if (step > 2 && currentStep === 2) {
                if (columnMapping.code === undefined) {
                    alert('Please map the required field: Supplier Part Number');
                    return;
                }
                if (columnMapping.listPrice === undefined && columnMapping.costPrice === undefined) {
                    alert('Please map at least one price field: either List Price OR Cost Price');
                    return;
                }
                // Prepare discount/markup columns if needed
                prepareStep3();
            }

            // Update step visibility
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');

            // Update tab highlighting
            document.querySelectorAll('.tab-btn').forEach((btn, index) => {
                btn.classList.remove('active');
                if (index + 1 === step) {
                    btn.classList.add('active');
                }
            });

            currentStep = step;

            // Render specific step content if needed
            if (step === 3) {
                renderSpreadsheet();
            } else if (step === 4) {
                renderPreviewOnly();
            } else if (step === 5) {
                renderPreviousPriceList();
            } else if (step === 6) {
                renderOriginalPriceList();
            } else if (step === 7) {
                processData();
                renderResults();
            } else if (step === 8) {
                processData();
                renderOWImportSheet();
            }
        }
        
        function renderPreviewOnly() {
            const table = document.getElementById('previewTable');
            const hasDiscount = columnMapping.discount !== undefined;
            const hasMarkup = columnMapping.markup !== undefined;
            const hasBothPrices = columnMapping.listPrice !== undefined && columnMapping.costPrice !== undefined;

            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Description</th>
                        ${hasBothPrices ? '<th>Cost Price</th>' : ''}
                        ${hasBothPrices ? '<th>List Price</th>' : ''}
                        ${!hasBothPrices ? `<th>${hasDiscount ? 'List Price' : 'Cost Price'}</th>` : ''}
                        ${hasDiscount ? '<th>Discount %</th>' : ''}
                        ${hasMarkup ? '<th>Markup %</th>' : ''}
                        ${!hasBothPrices ? `<th>Calculated ${hasDiscount ? 'Cost Price' : 'List Price'}</th>` : ''}
                        <th>Manufacturer</th>
                        <th>Country</th>
                        <th>Barcode</th>
                    </tr>
                </thead>
                <tbody>
            `;

            // Build rows HTML in a string first (more efficient than repeated innerHTML +=)
            let rowsHTML = '';

            // Filter out excluded rows, then take first 10 non-excluded rows
            const previewRows = currentData.slice(1)
                .filter((row, index) => !excludedRows.has(index + 1))
                .slice(0, 10);
            previewRows.forEach(row => {
                const listPrice = columnMapping.listPrice !== undefined ? parseFloat(row[columnMapping.listPrice]) || 0 : 0;
                const discount = columnMapping.discount !== undefined ? parseFloat(row[columnMapping.discount]) || 0 : 0;
                const markup = columnMapping.markup !== undefined ? parseFloat(row[columnMapping.markup]) || 0 : 0;
                const costPrice = columnMapping.costPrice !== undefined ? parseFloat(row[columnMapping.costPrice]) || 0 : 0;

                let calculatedValue = 0;
                if (hasDiscount) {
                    calculatedValue = costPrice > 0 ? costPrice : Math.round(listPrice * (1 - discount / 100) * 100) / 100;
                } else if (hasMarkup) {
                    calculatedValue = listPrice > 0 ? listPrice : Math.round(costPrice * (1 + markup / 100) * 100) / 100;
                }

                rowsHTML += `
                    <tr>
                        <td>${columnMapping.code !== undefined ? row[columnMapping.code] : '-'}</td>
                        <td>${columnMapping.description !== undefined ? row[columnMapping.description] : '-'}</td>
                        ${hasBothPrices ? `<td>${costPrice > 0 ? '¬£' + costPrice.toFixed(2) : '-'}</td>` : ''}
                        ${hasBothPrices ? `<td>${listPrice > 0 ? '¬£' + listPrice.toFixed(2) : '-'}</td>` : ''}
                        ${!hasBothPrices ? `<td>${hasDiscount ?
                            (listPrice > 0 ? '¬£' + listPrice.toFixed(2) : '-') :
                            (costPrice > 0 ? '¬£' + costPrice.toFixed(2) : '-')}</td>` : ''}
                        ${hasDiscount ? `<td>${discount > 0 ? discount.toFixed(1) + '%' : '-'}</td>` : ''}
                        ${hasMarkup ? `<td>${markup > 0 ? markup.toFixed(1) + '%' : '-'}</td>` : ''}
                        ${!hasBothPrices ? `<td style="background: #e8f5e9;">${calculatedValue > 0 ? '¬£' + calculatedValue.toFixed(2) : '-'}</td>` : ''}
                        <td>${columnMapping.manufacturer !== undefined ? row[columnMapping.manufacturer] : '-'}</td>
                        <td>${columnMapping.countryOfOrigin !== undefined ? row[columnMapping.countryOfOrigin] : '-'}</td>
                        <td>${columnMapping.barcode !== undefined ? row[columnMapping.barcode] : '-'}</td>
                    </tr>
                `;
            });

            table.innerHTML += rowsHTML + '</tbody>';

            // Make columns resizable
            makeColumnsResizable(table);
        }

        function findDuplicateVariantCodes() {
            const duplicates = new Set();
            const codeCounts = {};

            // Count occurrences of each variant code (case-insensitive, skip excluded rows)
            currentData.slice(1).forEach((row, index) => {
                const rowIndex = index + 1;
                if (excludedRows.has(rowIndex)) return;

                const code = columnMapping.code !== undefined ? row[columnMapping.code] : '';
                if (code) {
                    const normalizedCode = code.toString().toLowerCase();
                    codeCounts[normalizedCode] = (codeCounts[normalizedCode] || 0) + 1;
                }
            });

            // Find codes that appear more than once
            for (const [code, count] of Object.entries(codeCounts)) {
                if (count > 1) {
                    duplicates.add(code);
                }
            }

            return duplicates;
        }

        function renderOriginalPriceList() {
            const table = document.getElementById('originalPriceTable');
            const hasDiscount = columnMapping.discount !== undefined;
            const hasMarkup = columnMapping.markup !== undefined;

            // Find duplicate variant codes
            const duplicateVariantCodes = findDuplicateVariantCodes();

            // Ensure database export map is built (for performance)
            if (!databaseExportDataMap && databaseExportData && databaseExportData.length > 0) {
                buildDatabaseExportDataMap();
            }

            // Build previousDataMap as fallback if database export is not available
            if (!previousDataMap && previousData && previousData.length > 0) {
                buildPreviousDataMap();
            }

            table.innerHTML = `
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Manufacturer</th>
                        <th>Variant Code</th>
                        <th>Description</th>
                        <th style="text-align: center;">üî¢</th>
                        <th>Name would like to use</th>
                        <th>Previous Description</th>
                        <th style="text-align: center;">üî¢</th>
                        <th>Description to use</th>
                        <th>Cost Price</th>
                        <th>List Price</th>
                        <th>Barcode</th>
                        <th>Previous Barcode</th>
                        <th>Commodity Code</th>
                        <th>Previous Commodity Code</th>
                        <th>Commodity Code to use</th>
                        <th>Is Commodity Code valid?</th>
                        <th>Country Code</th>
                        <th>Previous Country Code</th>
                    </tr>
                </thead>
                <tbody>
            `;

            // Build rows HTML in a string first (more efficient than repeated innerHTML +=)
            let rowsHTML = '';

            // Process rows (show all rows, mark excluded ones)
            currentData.slice(1).forEach((row, index) => {
                const rowIndex = index + 1;
                const isExcluded = excludedRows.has(rowIndex);

                const code = columnMapping.code !== undefined ? row[columnMapping.code] : '';
                const description = columnMapping.description !== undefined ? row[columnMapping.description] : '';
                const barcode = columnMapping.barcode !== undefined ? row[columnMapping.barcode] : '';
                const manufacturer = columnMapping.manufacturer !== undefined ? row[columnMapping.manufacturer] : settings.manufacturerName;
                const commodityCode = columnMapping.commodityCode !== undefined ? row[columnMapping.commodityCode] : '';
                const countryCode = columnMapping.countryOfOrigin !== undefined ? row[columnMapping.countryOfOrigin] : (settings.defaultCOO || '');

                // Calculate prices
                const listPrice = columnMapping.listPrice !== undefined ? parseFloat(row[columnMapping.listPrice]) || 0 : 0;
                const discount = hasDiscount ? parseFloat(row[columnMapping.discount]) || 0 : 0;
                const markup = hasMarkup ? parseFloat(row[columnMapping.markup]) || 0 : 0;
                const directCostPrice = columnMapping.costPrice !== undefined ? parseFloat(row[columnMapping.costPrice]) || 0 : 0;

                let costPrice = directCostPrice;
                let finalListPrice = listPrice;

                if (hasDiscount) {
                    if (directCostPrice > 0) {
                        costPrice = directCostPrice;
                    } else if (listPrice > 0 && discount > 0) {
                        costPrice = Math.round(listPrice * (1 - discount / 100) * 100) / 100;
                    }
                } else if (hasMarkup) {
                    if (listPrice > 0) {
                        finalListPrice = listPrice;
                    } else if (directCostPrice > 0 && markup > 0) {
                        finalListPrice = Math.round(directCostPrice * (1 + markup / 100) * 100) / 100;
                    }
                    costPrice = directCostPrice;
                }

                // Name would like to use: MANUFACTURER ( CODE ) DESCRIPTION
                const nameWouldLike = `${manufacturer} ( ${code} ) ${description}`;

                // Check if this item exists in database export data first, then fall back to previous data
                let oldItem = null;
                if (databaseExportDataMap) {
                    oldItem = databaseExportDataMap.get(code.toLowerCase());
                }
                // Fall back to previous data if not found in database export
                if (!oldItem && previousDataMap) {
                    oldItem = previousDataMap.get(code.toLowerCase());
                }

                let previousDescription = '';
                let previousBarcode = '';
                let previousCommodityCode = '';
                let previousCountryCode = '';
                let descriptionToUse = '';

                if (oldItem) {
                    // Found in database export or previous data
                    // Check if this is from database export (has vad_variant_code field)
                    if (oldItem.vad_variant_code) {
                        // Database export data
                        previousDescription = oldItem.vad_description || '-';
                        previousBarcode = oldItem.vad_ean_code || '-';
                        previousCommodityCode = oldItem.vad_commodity_code || '-';
                        previousCountryCode = oldItem.vad_country_code_of_origin || '-';
                    } else {
                        // Previous price list data
                        previousDescription = oldItem.description || '-';
                        previousBarcode = oldItem.barcode || '-';
                        previousCommodityCode = oldItem.commoditycode || oldItem.commodityCode || '-';
                        previousCountryCode = oldItem.countrycode || oldItem.countryCode || oldItem.countryoforigin || oldItem.countryOfOrigin || '-';
                    }
                    descriptionToUse = previousDescription; // Default to previous description
                } else {
                    // New product
                    previousDescription = 'New product? Check if new';
                    previousBarcode = '-';
                    previousCommodityCode = '-';
                    previousCountryCode = '-';
                    descriptionToUse = nameWouldLike; // Use the formatted name
                }

                // Set default "Description to use" value only if not already set by user
                if (!descriptionToUseMap[rowIndex]) {
                    descriptionToUseMap[rowIndex] = descriptionToUse;
                }

                // Set default "Barcode to use" value only if not already set by user
                // Default to Previous Barcode unless it's blank or '-'
                if (!barcodeToUseMap[rowIndex]) {
                    if (previousBarcode && previousBarcode !== '-') {
                        barcodeToUseMap[rowIndex] = previousBarcode;
                    } else {
                        barcodeToUseMap[rowIndex] = barcode || '';
                    }
                }

                // Set default "Commodity Code to use" value only if not already set by user
                const commodityCodeToUse = previousCommodityCode && previousCommodityCode !== '-' ? previousCommodityCode : (commodityCode || '');
                if (!commodityCodeToUseMap[rowIndex]) {
                    commodityCodeToUseMap[rowIndex] = commodityCodeToUse;
                }

                // Set default "Country Code to use" value only if not already set by user
                // Default to Previous Country Code unless it's blank or '-'
                if (!countryCodeToUseMap[rowIndex]) {
                    if (previousCountryCode && previousCountryCode !== '-') {
                        countryCodeToUseMap[rowIndex] = previousCountryCode;
                    } else {
                        countryCodeToUseMap[rowIndex] = countryCode || '';
                    }
                }

                // Calculate character counts
                const nameCharCount = nameWouldLike.length;
                const descCharCount = descriptionToUseMap[rowIndex].length;

                // Style for "Name would like to use" character count
                let nameCharStyle = '';
                if (nameCharCount > 250) {
                    nameCharStyle = 'color: red; font-weight: bold;';
                } else if (nameCharCount >= descCharCount * 1.1) {
                    nameCharStyle = 'color: limegreen; font-weight: bold;';
                }

                // Style for "Description to use" character count
                const descCharStyle = descCharCount > 250 ? 'color: red; font-weight: bold;' : '';

                // Check if "Name would like to use" or "Previous Description" matches "Description to use"
                const nameMatchesDesc = nameWouldLike === descriptionToUseMap[rowIndex];
                const prevMatchesDesc = previousDescription === descriptionToUseMap[rowIndex];
                const nameTextColor = nameMatchesDesc ? 'color: #999;' : '';
                const prevTextColor = prevMatchesDesc ? 'color: #999;' : '';

                // Check if "Commodity Code" or "Previous Commodity Code" matches "Commodity Code to use"
                const codeMatchesCommodity = (commodityCode || '') === commodityCodeToUseMap[rowIndex];
                const prevMatchesCommodity = previousCommodityCode === commodityCodeToUseMap[rowIndex];
                const commodityCodeTextColor = codeMatchesCommodity ? 'color: #999;' : '';
                const prevCommodityCodeTextColor = prevMatchesCommodity ? 'color: #999;' : '';

                // Check if "Country Code" or "Previous Country Code" matches "Country Code to use"
                const codeMatchesCountry = (countryCode || '') === countryCodeToUseMap[rowIndex];
                const prevMatchesCountry = previousCountryCode === countryCodeToUseMap[rowIndex];
                const countryCodeTextColor = codeMatchesCountry ? 'color: #999;' : '';
                const prevCountryCodeTextColor = prevMatchesCountry ? 'color: #999;' : '';

                // Validate commodity code to use against database
                let commodityValidation = '';
                let commodityValidationBg = '';
                if (commodityCodeMap && commodityCodeToUseMap[rowIndex] && commodityCodeToUseMap[rowIndex] !== '-') {
                    const lookupResult = commodityCodeMap.get(commodityCodeToUseMap[rowIndex]);
                    if (lookupResult && lookupResult.category) {
                        // Found - show category (limit length for horizontal space)
                        const category = lookupResult.category;
                        const maxLength = 40; // Limit to 40 characters
                        commodityValidation = category.length > maxLength ?
                            category.substring(0, maxLength) + '...' : category;
                        commodityValidationBg = 'background: #d4edda;'; // Light green
                    } else {
                        commodityValidation = 'Not found!';
                        commodityValidationBg = 'background: #f8d7da;'; // Light red
                    }
                } else {
                    commodityValidation = '-';
                    commodityValidationBg = '';
                }

                // Check if this is a new product
                const isNewProduct = previousDescription === 'New product? Check if new';
                const yellowBg = '#ffe082';
                const redBg = '#ffcccc';

                // Check if this variant code is a duplicate
                const isDuplicateCode = duplicateVariantCodes.has(code.toLowerCase());

                // Set backgrounds based on whether it's a new product or duplicate
                const manufacturerBg = isNewProduct ? yellowBg : '#ffffe0';
                const codeBg = isDuplicateCode ? redBg : (isNewProduct ? yellowBg : '#ffffe0');
                const codeInputBg = isDuplicateCode ? redBg : 'transparent';
                const descriptionBg = isNewProduct ? yellowBg : '#ffffe0';
                const nameWouldLikeBg = isNewProduct ? yellowBg : '#ffe0f0';
                const prevDescBg = isNewProduct ? yellowBg : '#ffe5cc';
                const descToUseBg = isNewProduct ? yellowBg : '#ccffcc';
                const costListBg = isNewProduct ? `background: ${yellowBg};` : '';
                const barcodeBg = isNewProduct ? `background: ${yellowBg};` : '';

                rowsHTML += `
                    <tr class="${isExcluded ? 'excluded-row' : ''}">
                        <td class="row-number" style="cursor: pointer; background: #00ff00; text-align: center;" onclick="toggleRowExclusion(${rowIndex})" title="${isExcluded ? 'Click to restore row' : 'Click to exclude row'}">
                            ${isExcluded ? '‚ùå' : rowIndex}
                        </td>
                        <td style="background: ${manufacturerBg};">${manufacturer}</td>
                        <td style="background: ${codeBg}; padding: 0;">
                            <input type="text"
                                   id="codeInput_${rowIndex}"
                                   value="${code}"
                                   onchange="updateVariantCode(${rowIndex}, this.value)"
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 0; background: ${codeInputBg}; box-sizing: border-box;">
                        </td>
                        <td style="background: ${descriptionBg};">${description}</td>
                        <td id="nameCharCount_${rowIndex}" style="text-align: center; ${nameCharStyle} ${isNewProduct ? 'background: ' + yellowBg + ';' : ''}">${nameCharCount}</td>
                        <td id="nameCell_${rowIndex}" style="cursor: pointer; background: ${nameWouldLikeBg}; ${nameTextColor}"
                            onclick="setDescriptionToUseFromCell(${rowIndex}, 'nameCell_${rowIndex}')"
                            title="Click to use this as Description to use">${nameWouldLike}</td>
                        <td id="prevCell_${rowIndex}" style="${isNewProduct ? '' : 'cursor: pointer;'} background: ${prevDescBg}; ${prevTextColor}"
                            ${isNewProduct ? '' : `onclick="setDescriptionToUseFromCell(${rowIndex}, 'prevCell_${rowIndex}')"`}
                            ${isNewProduct ? '' : 'title="Click to use this as Description to use"'}>${previousDescription}</td>
                        <td id="charCount_${rowIndex}" style="text-align: center; ${descCharStyle} ${isNewProduct ? 'background: ' + yellowBg + ';' : ''}">${descCharCount}</td>
                        <td style="background: ${descToUseBg}; padding: 0;">
                            <input type="text"
                                   id="descInput_${rowIndex}"
                                   value="${descriptionToUseMap[rowIndex]}"
                                   onchange="updateDescriptionToUse(${rowIndex}, this.value)"
                                   oninput="updateCharCount(${rowIndex})"
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 0; background: transparent; box-sizing: border-box;">
                        </td>
                        <td style="${costListBg}">¬£${costPrice.toFixed(2)}</td>
                        <td style="${costListBg}">¬£${finalListPrice.toFixed(2)}</td>
                        <td id="barcodeCell_${rowIndex}" style="cursor: pointer; ${barcodeBg} ${(barcodeToUseMap[rowIndex] === (barcode || '')) ? 'color: #999;' : ''}"
                            onclick="setBarcodeToUseFromCell(${rowIndex}, 'barcodeCell_${rowIndex}')"
                            title="Click to use this barcode">${barcode || '-'}</td>
                        <td id="prevBarcodeCell_${rowIndex}" style="${(previousBarcode === '-') ? '' : 'cursor: pointer;'} ${barcodeBg} ${(barcodeToUseMap[rowIndex] === previousBarcode && previousBarcode !== '-') ? 'color: #999;' : ''}"
                            ${(previousBarcode === '-') ? '' : `onclick="setBarcodeToUseFromCell(${rowIndex}, 'prevBarcodeCell_${rowIndex}')"`}
                            ${(previousBarcode === '-') ? '' : 'title="Click to use this barcode"'}>${previousBarcode}</td>
                        <td id="commodityCodeCell_${rowIndex}" style="cursor: pointer; ${barcodeBg} ${commodityCodeTextColor}"
                            onclick="setCommodityCodeToUseFromCell(${rowIndex}, 'commodityCodeCell_${rowIndex}')"
                            title="Click to use this as Commodity Code to use">${commodityCode || '-'}</td>
                        <td id="prevCommodityCodeCell_${rowIndex}" style="${previousCommodityCode === '-' ? '' : 'cursor: pointer;'} ${barcodeBg} ${prevCommodityCodeTextColor}"
                            ${previousCommodityCode === '-' ? '' : `onclick="setCommodityCodeToUseFromCell(${rowIndex}, 'prevCommodityCodeCell_${rowIndex}')"`}
                            ${previousCommodityCode === '-' ? '' : 'title="Click to use this as Commodity Code to use"'}>${previousCommodityCode}</td>
                        <td style="${barcodeBg} padding: 0;">
                            <input type="text"
                                   id="commodityCodeInput_${rowIndex}"
                                   value="${commodityCodeToUseMap[rowIndex] || ''}"
                                   onchange="updateCommodityCodeToUse(${rowIndex}, this.value)"
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 0; background: transparent; box-sizing: border-box;">
                        </td>
                        <td id="commodityValidation_${rowIndex}" style="${commodityValidationBg}" title="${commodityValidation}">${commodityValidation}</td>
                        <td id="countryCodeCell_${rowIndex}" style="cursor: pointer; ${barcodeBg} ${countryCodeTextColor}"
                            onclick="setCountryCodeToUseFromCell(${rowIndex}, 'countryCodeCell_${rowIndex}')"
                            title="Click to use this country code">${countryCode || '-'}</td>
                        <td id="prevCountryCodeCell_${rowIndex}" style="${(previousCountryCode === '-') ? '' : 'cursor: pointer;'} ${barcodeBg} ${prevCountryCodeTextColor}"
                            ${(previousCountryCode === '-') ? '' : `onclick="setCountryCodeToUseFromCell(${rowIndex}, 'prevCountryCodeCell_${rowIndex}')"`}
                            ${(previousCountryCode === '-') ? '' : 'title="Click to use this country code"'}>${previousCountryCode}</td>
                    </tr>
                `;
            });

            table.innerHTML += rowsHTML + '</tbody>';

            // Make columns resizable
            makeColumnsResizable(table);
        }

        function updateDescriptionToUse(rowIndex, value) {
            descriptionToUseMap[rowIndex] = value;

            // Update character count display
            const charCountCell = document.getElementById(`charCount_${rowIndex}`);
            if (charCountCell) {
                const count = value.length;
                charCountCell.textContent = count;
                charCountCell.style.textAlign = 'center';

                // Update styling based on character count
                if (count > 250) {
                    charCountCell.style.color = 'red';
                    charCountCell.style.fontWeight = 'bold';
                } else {
                    charCountCell.style.color = '';
                    charCountCell.style.fontWeight = '';
                }
            }

            // No need to re-render - character count is updated live via oninput
        }

        function updateVariantCode(rowIndex, value) {
            // Update the currentData array directly
            if (columnMapping.code !== undefined) {
                currentData[rowIndex][columnMapping.code] = value;
            }

            // Clear the description for this row to trigger recalculation
            delete descriptionToUseMap[rowIndex];

            // Debounce re-render to prevent browser crashes
            if (renderDebounceTimer) {
                clearTimeout(renderDebounceTimer);
            }
            renderDebounceTimer = setTimeout(() => {
                safeRender(() => renderOriginalPriceList());
                renderDebounceTimer = null;
            }, 250); // 250ms debounce
        }

        function setDescriptionToUseFromCell(rowIndex, cellId) {
            // Get the value directly from the cell's textContent - NO ESCAPING!
            // This treats data as pure data, never as code
            const cell = document.getElementById(cellId);
            if (!cell) return;

            const value = cell.textContent; // Pure data - works with ANY characters

            // Update the map
            descriptionToUseMap[rowIndex] = value;

            // Directly update the DOM elements instead of re-rendering entire table
            const input = document.getElementById(`descInput_${rowIndex}`);
            const charCountCell = document.getElementById(`charCount_${rowIndex}`);
            const nameCell = document.getElementById(`nameCell_${rowIndex}`);
            const prevCell = document.getElementById(`prevCell_${rowIndex}`);

            if (input) {
                input.value = value;
            }

            if (charCountCell) {
                const count = value.length;
                charCountCell.textContent = count;
                charCountCell.style.textAlign = 'center';

                // Update styling based on character count
                if (count > 250) {
                    charCountCell.style.color = 'red';
                    charCountCell.style.fontWeight = 'bold';
                } else {
                    charCountCell.style.color = '';
                    charCountCell.style.fontWeight = '';
                }
            }

            // Update "Name would like to use" character count styling
            const nameCharCountCell = document.getElementById(`nameCharCount_${rowIndex}`);
            if (nameCharCountCell && nameCell) {
                const nameCharCount = nameCell.textContent.length;
                const descCharCount = value.length;

                // Apply styling logic
                if (nameCharCount > 250) {
                    nameCharCountCell.style.color = 'red';
                    nameCharCountCell.style.fontWeight = 'bold';
                } else if (nameCharCount === descCharCount) {
                    // Grey when equal
                    nameCharCountCell.style.color = '#999';
                    nameCharCountCell.style.fontWeight = '';
                } else if (nameCharCount >= descCharCount * 1.1) {
                    // Green when 10% longer
                    nameCharCountCell.style.color = 'limegreen';
                    nameCharCountCell.style.fontWeight = 'bold';
                } else {
                    // Default
                    nameCharCountCell.style.color = '';
                    nameCharCountCell.style.fontWeight = '';
                }
            }

            // Update greying out for Name and Previous Description cells
            if (nameCell) {
                const nameValue = nameCell.textContent;
                if (nameValue === value) {
                    nameCell.style.color = '#999'; // Grey out if matches
                } else {
                    nameCell.style.color = ''; // Normal color
                }
            }

            if (prevCell) {
                const prevValue = prevCell.textContent;
                if (prevValue === value) {
                    prevCell.style.color = '#999'; // Grey out if matches
                } else {
                    prevCell.style.color = ''; // Normal color
                }
            }

            // No need to re-render - we've updated the DOM directly!
        }

        function setBarcodeToUseFromCell(rowIndex, cellId) {
            // Get the value directly from the cell's textContent - NO ESCAPING!
            // This treats data as pure data, never as code
            const cell = document.getElementById(cellId);
            if (!cell) return;

            const value = cell.textContent; // Pure data - works with ANY characters

            // Update the map
            barcodeToUseMap[rowIndex] = value;

            // Directly update the DOM elements instead of re-rendering entire table
            const barcodeCell = document.getElementById(`barcodeCell_${rowIndex}`);
            const prevBarcodeCell = document.getElementById(`prevBarcodeCell_${rowIndex}`);

            // Update greying out for Barcode cells
            if (barcodeCell) {
                const barcodeValue = barcodeCell.textContent;
                if (barcodeValue === value) {
                    barcodeCell.style.color = '#999'; // Grey out if matches
                } else {
                    barcodeCell.style.color = ''; // Normal color
                }
            }

            if (prevBarcodeCell) {
                const prevBarcodeValue = prevBarcodeCell.textContent;
                if (prevBarcodeValue === value && prevBarcodeValue !== '-') {
                    prevBarcodeCell.style.color = '#999'; // Grey out if matches
                } else {
                    prevBarcodeCell.style.color = ''; // Normal color
                }
            }

            // No need to re-render - we've updated the DOM directly!
        }

        function setCommodityCodeToUseFromCell(rowIndex, cellId) {
            // Get the value directly from the cell's textContent - NO ESCAPING!
            const cell = document.getElementById(cellId);
            if (!cell) return;

            const value = cell.textContent; // Pure data - works with ANY characters

            // Update the map
            commodityCodeToUseMap[rowIndex] = value;

            // Directly update the DOM elements instead of re-rendering entire table
            const input = document.getElementById(`commodityCodeInput_${rowIndex}`);
            const validationCell = document.getElementById(`commodityValidation_${rowIndex}`);
            const codeCell = document.getElementById(`commodityCodeCell_${rowIndex}`);
            const prevCodeCell = document.getElementById(`prevCommodityCodeCell_${rowIndex}`);

            if (input) {
                input.value = value;
            }

            // Update validation
            if (validationCell) {
                let commodityValidation = '';
                let commodityValidationBg = '';

                if (commodityCodeMap && value && value !== '-') {
                    const lookupResult = commodityCodeMap.get(value);
                    if (lookupResult && lookupResult.category) {
                        // Found - show category (limit length)
                        const category = lookupResult.category;
                        const maxLength = 40;
                        commodityValidation = category.length > maxLength ?
                            category.substring(0, maxLength) + '...' : category;
                        validationCell.style.background = '#d4edda'; // Light green
                    } else {
                        commodityValidation = 'Not found!';
                        validationCell.style.background = '#f8d7da'; // Light red
                    }
                } else {
                    commodityValidation = '-';
                    validationCell.style.background = '';
                }

                validationCell.textContent = commodityValidation;
                validationCell.title = commodityValidation;
            }

            // Update greying out for Commodity Code and Previous Commodity Code cells
            if (codeCell) {
                const codeValue = codeCell.textContent;
                if (codeValue === value) {
                    codeCell.style.color = '#999'; // Grey out if matches
                } else {
                    codeCell.style.color = ''; // Normal color
                }
            }

            if (prevCodeCell) {
                const prevCodeValue = prevCodeCell.textContent;
                if (prevCodeValue === value) {
                    prevCodeCell.style.color = '#999'; // Grey out if matches
                } else {
                    prevCodeCell.style.color = ''; // Normal color
                }
            }

            // No need to re-render - we've updated the DOM directly!
        }

        function updateCommodityCodeToUse(rowIndex, value) {
            commodityCodeToUseMap[rowIndex] = value;

            // Update validation display
            const validationCell = document.getElementById(`commodityValidation_${rowIndex}`);
            if (validationCell) {
                let commodityValidation = '';

                if (commodityCodeMap && value && value !== '-') {
                    const lookupResult = commodityCodeMap.get(value);
                    if (lookupResult && lookupResult.category) {
                        // Found - show category (limit length)
                        const category = lookupResult.category;
                        const maxLength = 40;
                        commodityValidation = category.length > maxLength ?
                            category.substring(0, maxLength) + '...' : category;
                        validationCell.style.background = '#d4edda'; // Light green
                    } else {
                        commodityValidation = 'Not found!';
                        validationCell.style.background = '#f8d7da'; // Light red
                    }
                } else {
                    commodityValidation = '-';
                    validationCell.style.background = '';
                }

                validationCell.textContent = commodityValidation;
                validationCell.title = commodityValidation;
            }

            // Update greying for commodity code cells
            const codeCell = document.getElementById(`commodityCodeCell_${rowIndex}`);
            const prevCodeCell = document.getElementById(`prevCommodityCodeCell_${rowIndex}`);

            if (codeCell) {
                const codeValue = codeCell.textContent;
                if (codeValue === value) {
                    codeCell.style.color = '#999';
                } else {
                    codeCell.style.color = '';
                }
            }

            if (prevCodeCell) {
                const prevCodeValue = prevCodeCell.textContent;
                if (prevCodeValue === value) {
                    prevCodeCell.style.color = '#999';
                } else {
                    prevCodeCell.style.color = '';
                }
            }
        }

        function setCountryCodeToUseFromCell(rowIndex, cellId) {
            // Get the value directly from the cell's textContent - NO ESCAPING!
            // This treats data as pure data, never as code
            const cell = document.getElementById(cellId);
            if (!cell) return;

            const value = cell.textContent; // Pure data - works with ANY characters

            // Update the map
            countryCodeToUseMap[rowIndex] = value;

            // Directly update the DOM elements instead of re-rendering entire table
            const countryCodeCell = document.getElementById(`countryCodeCell_${rowIndex}`);
            const prevCountryCodeCell = document.getElementById(`prevCountryCodeCell_${rowIndex}`);

            // Update greying out for Country Code cells
            if (countryCodeCell) {
                const countryCodeValue = countryCodeCell.textContent;
                if (countryCodeValue === value) {
                    countryCodeCell.style.color = '#999'; // Grey out if matches
                } else {
                    countryCodeCell.style.color = ''; // Normal color
                }
            }

            if (prevCountryCodeCell) {
                const prevCountryCodeValue = prevCountryCodeCell.textContent;
                if (prevCountryCodeValue === value && prevCountryCodeValue !== '-') {
                    prevCountryCodeCell.style.color = '#999'; // Grey out if matches
                } else {
                    prevCountryCodeCell.style.color = ''; // Normal color
                }
            }

            // No need to re-render - we've updated the DOM directly!
        }

        function updateCharCount(rowIndex) {
            const input = document.getElementById(`descInput_${rowIndex}`);
            const charCountCell = document.getElementById(`charCount_${rowIndex}`);
            const nameCell = document.getElementById(`nameCell_${rowIndex}`);
            const prevCell = document.getElementById(`prevCell_${rowIndex}`);

            if (input && charCountCell) {
                const count = input.value.length;
                charCountCell.textContent = count;

                // IMPORTANT: Also update the map to preserve value during re-renders
                // This prevents losing unsaved typing if user clicks another cell
                descriptionToUseMap[rowIndex] = input.value;

                // Update styling based on character count (always keep text-align: center)
                charCountCell.style.textAlign = 'center';
                if (count > 250) {
                    charCountCell.style.color = 'red';
                    charCountCell.style.fontWeight = 'bold';
                } else {
                    charCountCell.style.color = '';
                    charCountCell.style.fontWeight = '';
                }

                // Update "Name would like to use" character count styling as user types
                const nameCharCountCell = document.getElementById(`nameCharCount_${rowIndex}`);
                if (nameCharCountCell && nameCell) {
                    const nameCharCount = nameCell.textContent.length;
                    const descCharCount = count;

                    // Apply styling logic
                    if (nameCharCount > 250) {
                        nameCharCountCell.style.color = 'red';
                        nameCharCountCell.style.fontWeight = 'bold';
                    } else if (nameCharCount === descCharCount) {
                        // Grey when equal
                        nameCharCountCell.style.color = '#999';
                        nameCharCountCell.style.fontWeight = '';
                    } else if (nameCharCount >= descCharCount * 1.1) {
                        // Green when 10% longer
                        nameCharCountCell.style.color = 'limegreen';
                        nameCharCountCell.style.fontWeight = 'bold';
                    } else {
                        // Default
                        nameCharCountCell.style.color = '';
                        nameCharCountCell.style.fontWeight = '';
                    }
                }

                // Update greying out for Name and Previous Description cells as user types
                // Compare against textContent (actual displayed value) not data-value (escaped version)
                const currentValue = input.value;

                if (nameCell) {
                    const nameValue = nameCell.textContent;
                    if (nameValue === currentValue) {
                        nameCell.style.color = '#999'; // Grey out if matches
                    } else {
                        nameCell.style.color = ''; // Normal color
                    }
                }

                if (prevCell) {
                    const prevValue = prevCell.textContent;
                    if (prevValue === currentValue) {
                        prevCell.style.color = '#999'; // Grey out if matches
                    } else {
                        prevCell.style.color = ''; // Normal color
                    }
                }
            }
        }

        function renderSpreadsheetStep3() {
            // This function is no longer needed - removed Step 3 spreadsheet
        }
        
        function renderMapping() {
            // This function is no longer needed since mapping is done in step 2
        }
        
        function updateMapping() {
            // This function is no longer needed since we use updateColumnMapping
        }
        
        function renderPreview() {
            // This function is no longer needed since preview is in step 3
        }

        function renderPreviousPriceList(sortBy = 'code') {
            const table = document.getElementById('previousPriceTable');

            if (!previousData || previousData.length === 0) {
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th colspan="6">No previous price list data available</th>
                        </tr>
                    </thead>
                `;
                return;
            }

            // Build previous price list data with status
            previousPriceListData = previousData.map(oldItem => {
                const code = oldItem.code || oldItem.productcode || '';
                const description = oldItem.description || '';
                const costPrice = parseFloat(oldItem.costPrice || oldItem.costprice || 0);
                const listPrice = parseFloat(oldItem.listPrice || oldItem.listprice || 0);
                const barcode = oldItem.barcode || '';

                // Check if this code exists in current data (non-excluded rows only)
                let status = 'Missing';
                if (code) {
                    const codeCol = columnMapping.code;
                    if (codeCol !== undefined) {
                        for (let i = 1; i < currentData.length; i++) {
                            if (excludedRows.has(i)) continue;
                            const currentCode = currentData[i][codeCol];
                            if (currentCode && currentCode.toLowerCase() === code.toLowerCase()) {
                                status = 'Found';
                                break;
                            }
                        }
                    }
                }

                return {
                    code,
                    description,
                    costPrice,
                    listPrice,
                    barcode,
                    status
                };
            });

            // Sort the data
            if (sortBy === 'status') {
                // Sort by status (Missing first), then by code
                previousPriceListData.sort((a, b) => {
                    if (a.status === b.status) {
                        return a.code.localeCompare(b.code);
                    }
                    return a.status === 'Missing' ? -1 : 1;
                });
            } else if (sortBy === 'code') {
                previousPriceListData.sort((a, b) => a.code.localeCompare(b.code));
            }

            // Build table
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Description</th>
                        <th>Cost Price</th>
                        <th>List Price</th>
                        <th>Barcode</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
            `;

            let rowsHTML = '';
            previousPriceListData.forEach(item => {
                const statusClass = item.status === 'Missing' ? 'style="background: #ffcccc; font-weight: bold;"' : 'style="background: #ccffcc;"';
                rowsHTML += `
                    <tr>
                        <td>${item.code}</td>
                        <td>${item.description}</td>
                        <td>${item.costPrice > 0 ? '¬£' + item.costPrice.toFixed(2) : '-'}</td>
                        <td>${item.listPrice > 0 ? '¬£' + item.listPrice.toFixed(2) : '-'}</td>
                        <td>${item.barcode || '-'}</td>
                        <td ${statusClass}>${item.status}</td>
                    </tr>
                `;
            });

            table.innerHTML += rowsHTML + '</tbody>';

            // Make columns resizable
            makeColumnsResizable(table);
        }

        function sortPreviousPriceList(sortBy) {
            renderPreviousPriceList(sortBy);
        }

        function processData() {
            // Mapping is already validated in validateAndProcess
            
            const hasDiscount = columnMapping.discount !== undefined;
            const hasMarkup = columnMapping.markup !== undefined;

            // Convert data to objects (skip excluded rows)
            processedData = currentData.slice(1).map((row, index) => {
                const rowIndex = index + 1; // Adjust for header row
                if (excludedRows.has(rowIndex)) {
                    return null; // Mark for filtering
                }
                return { row, rowIndex }; // Keep rowIndex with the row
            }).filter(item => item !== null).map(({ row, rowIndex }) => {
                const listPrice = columnMapping.listPrice !== undefined ? parseFloat(row[columnMapping.listPrice]) || 0 : 0;
                const discount = hasDiscount ? parseFloat(row[columnMapping.discount]) || 0 : 0;
                const markup = hasMarkup ? parseFloat(row[columnMapping.markup]) || 0 : 0;
                const directCostPrice = columnMapping.costPrice !== undefined ? parseFloat(row[columnMapping.costPrice]) || 0 : 0;
                
                let costPrice = directCostPrice;
                let finalListPrice = listPrice;
                let calculatedFrom = '';
                
                if (hasDiscount) {
                    // Using discount: calculate cost from list price
                    if (directCostPrice > 0) {
                        costPrice = directCostPrice;
                    } else if (listPrice > 0 && discount > 0) {
                        costPrice = Math.round(listPrice * (1 - discount / 100) * 100) / 100;
                        calculatedFrom = 'discount';
                    }
                } else if (hasMarkup) {
                    // Using markup: calculate list price from cost
                    if (listPrice > 0) {
                        finalListPrice = listPrice;
                    } else if (directCostPrice > 0 && markup > 0) {
                        finalListPrice = Math.round(directCostPrice * (1 + markup / 100) * 100) / 100;
                        calculatedFrom = 'markup';
                    }
                    costPrice = directCostPrice;
                }
                
                const code = row[columnMapping.code];
                const item = {
                    code: code,
                    description: descriptionToUseMap[rowIndex] || (columnMapping.description !== undefined ? row[columnMapping.description] : ''),
                    costPrice: costPrice,
                    listPrice: finalListPrice,
                    discount: discount,
                    markup: markup,
                    manufacturer: columnMapping.manufacturer !== undefined ? row[columnMapping.manufacturer] : '',
                    countryOfOrigin: countryCodeToUseMap[rowIndex] || (columnMapping.countryOfOrigin !== undefined ? row[columnMapping.countryOfOrigin] : ''),
                    commodityCode: commodityCodeToUseMap[rowIndex] || (columnMapping.commodityCode !== undefined ? row[columnMapping.commodityCode] : ''),
                    calculatedFrom: calculatedFrom,
                    barcode: barcodeToUseMap[rowIndex] || (columnMapping.barcode !== undefined ? row[columnMapping.barcode] : '')
                };

                // Get database export data for comparison (O(1) lookup)
                const dbItem = databaseExportDataMap ? databaseExportDataMap.get(item.code.toLowerCase()) : null;
                if (dbItem) {
                    item.db_description = dbItem.vad_description || '';
                    item.db_cost = parseFloat(dbItem.vasd_standard_cost) || 0;
                    item.db_commodity = dbItem.vad_commodity_code || '';
                    item.db_weight = dbItem.vad_weight || '';
                    item.db_length = dbItem.vad_length || '';
                    item.db_width = dbItem.vad_width || '';
                    item.db_depth = dbItem.vad_depth || '';
                }

                // Compare with database export data for cost change (use database as source of truth)
                if (dbItem && item.db_cost > 0) {
                    // Product exists in database - calculate cost change from database cost
                    item.costChange = ((item.costPrice - item.db_cost) / item.db_cost) * 100;
                    item.oldCostPrice = item.db_cost;
                    item.status = 'changed';

                    // Flag if significant change
                    item.flagged = (
                        (item.costChange >= 15 || item.costChange <= -10) && item.costPrice >= 100
                    );
                } else {
                    // New product (not in database)
                    item.status = 'new';
                    item.flagged = false;
                    item.costChange = 0;
                }

                // Note: Previous price list data is only used for Previous List tab (Step 5)
                // All other comparisons use database export data
                
                return item;
            }).filter(item => item.code); // Remove empty rows
        }
        
        function renderResults() {
            // Stats
            const total = processedData.length;
            const newItems = processedData.filter(i => i.status === 'new').length;
            const changed = processedData.filter(i => i.status === 'changed').length;
            const flagged = processedData.filter(i => i.flagged).length;
            
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${total}</div>
                    <div class="stat-label">Total Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${newItems}</div>
                    <div class="stat-label">New Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${changed}</div>
                    <div class="stat-label">Changed Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #dc3545;">${flagged}</div>
                    <div class="stat-label">Flagged Items</div>
                </div>
            `;
            
            if (flagged > 0) {
                document.getElementById('flaggedAlert').style.display = 'block';
            }
            
            // Comparison table
            renderComparisonTable(processedData);
        }
        
        function findDuplicateCodesInProcessedData(data) {
            const duplicates = new Set();
            const codeCounts = {};

            // Count occurrences of each code (case-insensitive)
            data.forEach(item => {
                if (item.code) {
                    const normalizedCode = item.code.toString().toLowerCase();
                    codeCounts[normalizedCode] = (codeCounts[normalizedCode] || 0) + 1;
                }
            });

            // Find codes that appear more than once
            for (const [code, count] of Object.entries(codeCounts)) {
                if (count > 1) {
                    duplicates.add(code);
                }
            }

            return duplicates;
        }

        function renderComparisonTable(data) {
            const table = document.getElementById('comparisonTable');

            // Find duplicate codes in the data
            const duplicateCodes = findDuplicateCodesInProcessedData(data);

            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Description</th>
                        <th>Cost Price</th>
                        <th>Previous Cost</th>
                        <th>List Price</th>
                        <th>Difference</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
            `;

            // Build rows HTML in a string first (more efficient than repeated innerHTML +=)
            let rowsHTML = '';

            data.forEach(item => {
                const costChangeClass = item.costChange > 0 ? 'change-positive' : item.costChange < 0 ? 'change-negative' : '';

                const statusBadge = item.status === 'new' ?
                    '<span class="badge badge-info">NEW</span>' :
                    item.flagged ? '<span class="badge badge-warning">FLAGGED</span>' :
                    '<span class="badge badge-success">OK</span>';

                const costPriceDisplay = item.calculatedFrom === 'discount' ?
                    `¬£${item.costPrice.toFixed(2)} <small>(calc from discount)</small>` :
                    `¬£${item.costPrice.toFixed(2)}`;

                const listPriceDisplay = item.calculatedFrom === 'markup' ?
                    `¬£${item.listPrice.toFixed(2)} <small>(calc from markup)</small>` :
                    `¬£${item.listPrice.toFixed(2)}`;

                const rowClass = item.status === 'new' ? 'new-product' : (item.flagged ? 'flagged' : '');
                const isDuplicate = item.code && duplicateCodes.has(item.code.toString().toLowerCase());
                const codeStyle = isDuplicate ? 'background: #ffcccc;' : '';

                // Helper function to compare values and highlight differences
                const compareStyle = (current, db) => {
                    if (!db && db !== 0) return ''; // No DB data available
                    const currentStr = (current || '').toString().toLowerCase().trim();
                    const dbStr = (db || '').toString().toLowerCase().trim();
                    return currentStr !== dbStr ? 'background: #fff3cd; font-weight: bold;' : '';
                };

                const costDifference = item.status === 'new' ? 0 : (item.costPrice - item.db_cost);
                const costDifferenceDisplay = item.status === 'new' ? '-' :
                    `${costDifference > 0 ? '+' : ''}¬£${costDifference.toFixed(2)}<br>
                     <small>${item.costChange > 0 ? '+' : ''}${item.costChange.toFixed(1)}%</small>`;

                rowsHTML += `
                    <tr class="${rowClass}">
                        <td style="${codeStyle}">${item.code}</td>
                        <td>${item.description || '-'}</td>
                        <td>${costPriceDisplay}</td>
                        <td>${item.db_cost ? '¬£' + item.db_cost.toFixed(2) : '-'}</td>
                        <td>${listPriceDisplay}</td>
                        <td class="${costChangeClass}">
                            ${costDifferenceDisplay}
                        </td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });

            table.innerHTML += rowsHTML + '</tbody>';

            // Make columns resizable
            makeColumnsResizable(table);
        }

        function toggleFilter() {
            const showAllItemsCheckbox = document.getElementById('showAllItems');
            const showOnlyFlaggedCheckbox = document.getElementById('showOnlyFlagged');
            const showOnlyNewCheckbox = document.getElementById('showOnlyNew');

            // Make checkboxes mutually exclusive
            const lastClicked = event.target.id;

            // Uncheck other checkboxes when one is clicked
            if (lastClicked === 'showAllItems') {
                showOnlyFlaggedCheckbox.checked = false;
                showOnlyNewCheckbox.checked = false;
            } else if (lastClicked === 'showOnlyFlagged') {
                showAllItemsCheckbox.checked = false;
                showOnlyNewCheckbox.checked = false;
            } else if (lastClicked === 'showOnlyNew') {
                showAllItemsCheckbox.checked = false;
                showOnlyFlaggedCheckbox.checked = false;
            }

            // Ensure at least one is always checked (default to showAll if none checked)
            if (!showAllItemsCheckbox.checked && !showOnlyFlaggedCheckbox.checked && !showOnlyNewCheckbox.checked) {
                showAllItemsCheckbox.checked = true;
            }

            let dataToShow = processedData;

            if (showOnlyFlaggedCheckbox.checked) {
                // Show only flagged items
                dataToShow = processedData.filter(i => i.flagged);
            } else if (showOnlyNewCheckbox.checked) {
                // Show only new items
                dataToShow = processedData.filter(i => i.status === 'new');
            }
            // else showAllItems is checked - show all processedData (default)

            renderComparisonTable(dataToShow);
        }

        // Keep old function name for backwards compatibility
        function toggleFlaggedFilter() {
            toggleFilter();
        }
        
        function renderOWImportSheet() {
            const table = document.getElementById('owImportTable');

            // Define OW Import Sheet columns
            const columns = [
                'Supplier',
                'Suppliers Part Code',
                'Description',
                'Category',
                'Cost Price',
                'List Price',
                'Retro %',
                'Serial Tracked?',
                'Price List Name',
                'EAN Code',
                'Notes',
                'Manufacturer',
                'Main Supplier',
                'vad_country_code_of_origin',
                'vad_weight',
                'vad_volume',
                'vad_length',
                'vad_width',
                'vad_depth',
                'vad_commodity_description',
                'vad_commodity_code',
                'vad_import_commodity_code',
                'vad_harmonisation_code',
                'vad_comments'
            ];

            // Format the effective date to "MMM YYYY-GBP 1.0"
            const formatPriceListName = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                return `${month} ${year}-GBP 1.0`;
            };

            const priceListName = formatPriceListName(settings.effectiveDate);

            // Build table header
            let tableHTML = `
                <thead>
                    <tr>
                        ${columns.map(col => `<th>${col}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
            `;

            // Build rows HTML in a string
            let rowsHTML = '';

            // Use processedData to populate rows
            processedData.forEach(item => {
                // Get barcode from user's selection (already set in processedData from barcodeToUseMap)
                const eanCode = item.barcode || '';

                // Get manufacturer - use item's manufacturer or fall back to settings
                const manufacturer = item.manufacturer || settings.manufacturerName;

                // Get country of origin - prefer database export data, then current data
                const countryOfOrigin = item.db_country || item.countryOfOrigin || '';

                // Get dimensions and other fields from database export data
                const weight = item.db_weight || '';
                const length = item.db_length || '';
                const width = item.db_width || '';
                const depth = item.db_depth || '';
                // Get commodity code from database (Previous Commodity Code from Original List)
                const commodityCode = item.db_commodity || item.commodityCode || '';

                // Build row data
                const rowData = [
                    settings.supplierAccountNumber,        // Supplier
                    item.code,                              // Suppliers Part Code
                    item.description,                       // Description
                    '',                                     // Category (empty for now)
                    item.costPrice.toFixed(2),              // Cost Price
                    item.listPrice.toFixed(2),              // List Price
                    '0',                                    // Retro % (0 for now)
                    'TRUE',                                 // Serial Tracked? (TRUE for now)
                    priceListName,                          // Price List Name
                    eanCode,                                // EAN Code
                    '',                                     // Notes (empty for now)
                    manufacturer,                           // Manufacturer
                    'TRUE',                                 // Main Supplier (TRUE for now)
                    countryOfOrigin,                        // vad_country_code_of_origin
                    weight,                                 // vad_weight
                    '',                                     // vad_volume (empty for now)
                    length,                                 // vad_length
                    width,                                  // vad_width
                    depth,                                  // vad_depth
                    '',                                     // vad_commodity_description (empty)
                    commodityCode,                          // vad_commodity_code (from database)
                    commodityCode,                          // vad_import_commodity_code (from database)
                    '',                                     // vad_harmonisation_code (empty for now)
                    ''                                      // vad_comments (empty for now)
                ];

                rowsHTML += `
                    <tr>
                        ${rowData.map(val => `<td>${val || '-'}</td>`).join('')}
                    </tr>
                `;
            });

            tableHTML += rowsHTML + '</tbody>';
            table.innerHTML = tableHTML;

            // Make columns resizable
            makeColumnsResizable(table);
        }

        function exportOWImportExcel() {
            // Define OW Import Sheet columns
            const columns = [
                'Supplier',
                'Suppliers Part Code',
                'Description',
                'Category',
                'Cost Price',
                'List Price',
                'Retro %',
                'Serial Tracked?',
                'Price List Name',
                'EAN Code',
                'Notes',
                'Manufacturer',
                'Main Supplier',
                'vad_country_code_of_origin',
                'vad_weight',
                'vad_volume',
                'vad_length',
                'vad_width',
                'vad_depth',
                'vad_commodity_description',
                'vad_commodity_code',
                'vad_import_commodity_code',
                'vad_harmonisation_code',
                'vad_comments'
            ];

            // Format the effective date to "MMM YYYY-GBP 1.0"
            const formatPriceListName = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                return `${month} ${year}-GBP 1.0`;
            };

            const priceListName = formatPriceListName(settings.effectiveDate);

            // Build data array starting with headers
            const data = [columns];

            // Build rows with actual data
            processedData.forEach(item => {
                // Get barcode from user's selection (already set in processedData from barcodeToUseMap)
                const eanCode = item.barcode || '';

                // Get manufacturer - use item's manufacturer or fall back to settings
                const manufacturer = item.manufacturer || settings.manufacturerName;

                // Get country of origin - prefer database export data, then current data
                const countryOfOrigin = item.db_country || item.countryOfOrigin || '';

                // Get dimensions and other fields from database export data
                const weight = item.db_weight || '';
                const length = item.db_length || '';
                const width = item.db_width || '';
                const depth = item.db_depth || '';
                // Get commodity code from database (Previous Commodity Code from Original List)
                const commodityCode = item.db_commodity || item.commodityCode || '';

                // Build row data
                const rowData = [
                    settings.supplierAccountNumber,        // Supplier
                    item.code,                              // Suppliers Part Code
                    item.description,                       // Description
                    '',                                     // Category (empty for now)
                    item.costPrice.toFixed(2),              // Cost Price
                    item.listPrice.toFixed(2),              // List Price
                    '0',                                    // Retro % (0 for now)
                    'TRUE',                                 // Serial Tracked? (TRUE for now)
                    priceListName,                          // Price List Name
                    eanCode,                                // EAN Code
                    '',                                     // Notes (empty for now)
                    manufacturer,                           // Manufacturer
                    'TRUE',                                 // Main Supplier (TRUE for now)
                    countryOfOrigin,                        // vad_country_code_of_origin
                    weight,                                 // vad_weight
                    '',                                     // vad_volume (empty for now)
                    length,                                 // vad_length
                    width,                                  // vad_width
                    depth,                                  // vad_depth
                    '',                                     // vad_commodity_description (empty)
                    commodityCode,                          // vad_commodity_code (from database)
                    commodityCode,                          // vad_import_commodity_code (from database)
                    '',                                     // vad_harmonisation_code (empty for now)
                    ''                                      // vad_comments (empty for now)
                ];

                data.push(rowData);
            });

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'OW Import');

            // Download Excel file
            XLSX.writeFile(wb, `ow_import_sheet_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
    </script>
</body>
</html>